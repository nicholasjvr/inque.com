import{a as X,d as T}from"./auth-Dy9B-T86.js";import{getDocs as Y,collection as F,addDoc as Q,serverTimestamp as Z,query as ee,orderBy as te,limit as ne,onSnapshot as se}from"https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";import{onAuthStateChanged as oe}from"https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";import"./profile_banner-HbanVse1.js";import"https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";import"https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";const L=document.getElementById("users-container"),r=document.getElementById("userSearch"),v=document.getElementById("filterSelect"),E=document.getElementById("sortSelect"),h=document.getElementById("refreshBtn"),P=document.getElementById("loadMoreBtn"),D=document.getElementById("loadMoreContainer"),M=document.getElementById("emptyState"),N=document.getElementById("clearFiltersBtn"),O=document.getElementById("chatModal"),ae=document.getElementById("chat-with-user"),q=document.getElementById("closeChat"),S=document.getElementById("chat-messages"),b=document.getElementById("chat-message-input"),p=document.getElementById("chat-send-btn"),_=document.getElementById("errorModal"),re=document.getElementById("errorTitle"),ie=document.getElementById("errorMessage"),B=document.getElementById("errorRetryBtn"),j=document.getElementById("errorCloseBtn"),H=document.getElementById("toastContainer");let l=null,f=null,g=null,u=[],m=[],w=[],k=0;const I=12;async function K(){try{if(console.log("🚀 [USERS] Initializing users page"),u=await J(),!u.length){x("No users found yet. Check back later!");return}d(),le(),console.log("✅ [USERS] Users page initialized successfully")}catch(e){console.error("❌ [USERS] Error initializing users page:",e),x("Failed to load users. Please refresh the page.")}}function d(){const e=r?.value||"",s=v?.value||"all",t=E?.value||"name";m=de(u,e,s),m=ue(m,t),k=0,w=[],G()}function G(){if(!m.length){x("No users match your current filters.");return}const e=me(m,k);k===0&&(L.innerHTML=""),e.forEach(t=>{const n=ce(t);L.appendChild(n)}),w=[...w,...e];const s=w.length<m.length;D.style.display=s?"flex":"none",M.style.display=m.length===0?"flex":"none"}function ce(e){const s=document.createElement("div");s.className="user-card",s.dataset.uid=e.id,s.dataset.name=e.name||"Anonymous User";const t=e.isOnline?'<div class="online-indicator"></div>':"",n=e.skills?e.skills.slice(0,4).map(c=>`<span class="skill-badge">${c}</span>`).join(""):"",o=he(e.lastActive);s.innerHTML=`
    <div class="user-card-header">
      <div class="user-card-pic" style="background-image: url(${e.photoURL||"assets/imgs/portal_placeholder.gif"})"></div>
      ${t}
    </div>

    <div class="user-card-content">
      <h3 class="user-card-name">${e.name||"Anonymous User"}</h3>
      <p class="user-card-bio">${e.bio||"Creative developer exploring the digital universe! 🚀"}</p>

      <div class="user-card-stats">
        <div class="stat">
          <span class="stat-icon">📊</span>
          <span class="stat-value">${e.projectCount||0}</span>
          <span class="stat-label">Projects</span>
        </div>
        <div class="stat">
          <span class="stat-icon">🕐</span>
          <span class="stat-value">${o}</span>
          <span class="stat-label">Active</span>
        </div>
      </div>

      <div class="user-card-skills">
        ${n}
      </div>
    </div>

    <div class="user-card-actions">
      <button class="chat-btn">
        <span class="btn-icon">💬</span>
        <span class="btn-text">Chat</span>
      </button>
      <a href="/?user=${e.id}" class="view-profile-btn">
        <span class="btn-icon">👤</span>
        <span class="btn-text">Profile</span>
      </a>
      <button class="follow-btn">
        <span class="btn-icon">➕</span>
        <span class="btn-text">Follow</span>
      </button>
    </div>
  `;const a=s.querySelector(".chat-btn"),i=s.querySelector(".follow-btn");return a.addEventListener("click",c=>{c.stopPropagation(),pe(e)}),i.addEventListener("click",c=>{c.stopPropagation(),ge(e)}),s}function x(e){L.innerHTML="",D.style.display="none",M.style.display="flex";const s=M.querySelector("p");s&&(s.textContent=e)}function le(){if(r){let e;r.addEventListener("input",s=>{clearTimeout(e),e=setTimeout(()=>{d()},300)})}v&&v.addEventListener("change",d),E&&E.addEventListener("change",d),h&&h.addEventListener("click",async()=>{h.disabled=!0,h.innerHTML='<span>🔄</span><span class="btn-text">Loading...</span>';try{u=await J(),d(),R("Users refreshed!","success")}catch{R("Failed to refresh users","error")}finally{h.disabled=!1,h.innerHTML='<span>🔄</span><span class="btn-text">Refresh</span>'}}),P&&P.addEventListener("click",()=>{k++,G(),w.length>I&&L.lastElementChild.scrollIntoView({behavior:"smooth",block:"end"})}),N&&N.addEventListener("click",()=>{r&&(r.value=""),v&&(v.value="all"),E&&(E.value="name"),d()}),q&&q.addEventListener("click",Ee),p&&p.addEventListener("click",z),b&&b.addEventListener("keypress",e=>{e.key==="Enter"&&z()}),j&&j.addEventListener("click",A),B&&B.addEventListener("click",()=>{A(),K()})}function de(e,s,t){let n=[...e];if(s){const o=s.toLowerCase();n=n.filter(a=>a.name?.toLowerCase().includes(o)||a.email?.toLowerCase().includes(o)||a.bio?.toLowerCase().includes(o)||a.skills?.some(i=>i.toLowerCase().includes(o)))}if(t!=="all")switch(t){case"online":n=n.filter(a=>a.isOnline);break;case"recent":const o=new Date(Date.now()-1440*60*1e3);n=n.filter(a=>a.lastActive&&new Date(a.lastActive)>o);break;case"creators":n=n.filter(a=>a.projectCount>0);break}return n}function ue(e,s){const t=[...e];switch(s){case"name":return t.sort((n,o)=>(n.name||"").localeCompare(o.name||""));case"recent":return t.sort((n,o)=>new Date(o.lastActive||0)-new Date(n.lastActive||0));case"projects":return t.sort((n,o)=>(o.projectCount||0)-(n.projectCount||0));case"random":return t.sort(()=>Math.random()-.5);default:return t}}function me(e,s){const t=s*I,n=t+I;return e.slice(t,n)}K();function C(e,s,t=null){re.textContent=e,ie.textContent=s,_.style.display="flex",t&&(B.onclick=()=>{A(),t()})}function A(){_.style.display="none"}function y(e,s="Unknown"){console.error(`❌ [USERS] Error in ${s}:`,e);let t="Error",n="An unexpected error occurred.";e.code==="permission-denied"?(t="Access Denied",n="You don't have permission to access this feature. Please log in."):e.code==="unavailable"?(t="Connection Error",n="Unable to connect to the server. Please check your internet connection."):e.code==="not-found"?(t="Not Found",n="The requested resource was not found."):e.message.includes("recaptcha")&&(t="Security Check Failed",n="The security verification failed. Please try again."),C(t,n)}async function J(){try{console.log("📡 [USERS] Fetching users from database");const e=await Y(F(T,"users")),s=[];return e.forEach(t=>{if(l&&t.id===l.uid)return;const n={id:t.id,...t.data()};n.isOnline=Math.random()>.7,n.projectCount=Math.floor(Math.random()*10),n.lastActive=new Date(Date.now()-Math.random()*7*24*60*60*1e3),n.bio=n.bio||"Creative developer exploring the digital universe! 🚀",n.skills=n.skills||["JavaScript","React","Design","Innovation"],s.push(n)}),console.log(`✅ [USERS] Loaded ${s.length} users`),s}catch(e){throw console.error("❌ [USERS] Error fetching users:",e),y(e,"fetchUsers"),e}}function fe(){console.log("📈 [USERS] Updating user statistics");const e=u.length,s=u.filter(n=>n.isOnline).length,t=u.filter(n=>{if(!n.lastActive)return!1;const o=new Date(Date.now()-1440*60*1e3);return new Date(n.lastActive)>o}).length;U("total-users",e),U("online-users",s),U("active-today",t)}function U(e,s){const t=document.getElementById(e);if(!t)return;const n=parseInt(t.textContent)||0,o=1e3,a=performance.now();function i(c){const V=c-a,$=Math.min(V/o,1),W=Math.round(n+(s-n)*$);t.textContent=W,$<1&&requestAnimationFrame(i)}requestAnimationFrame(i)}function R(e,s="info"){const t=document.createElement("div");t.className=`toast-notification ${s}`,t.textContent=e,H?H.appendChild(t):document.body.appendChild(t),t.classList.add("fade-in"),setTimeout(()=>{t.parentNode&&(t.style.opacity="0",t.style.transform="translateX(100%)",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))},4e3)}function he(e){if(!e)return"Unknown";const n=(new Date-new Date(e))/(1e3*60*60),o=n/24;return n<1?"Just now":n<24?`${Math.floor(n)}h ago`:o<7?`${Math.floor(o)}d ago`:`${Math.floor(o/7)}w ago`}function pe(e){if(!l){C("Login Required","Please log in to start a chat with other users.",()=>{window.location.href="/"});return}ye(e.id,e.name||"Anonymous User")}function ge(e){if(console.log("➕ [USERS] Follow button clicked for:",e.name),!l){C("Login Required","Please log in to follow other users.",()=>{window.location.href="/"});return}R(`Now following ${e.name||"this user"}! 🎉`,"success")}function ye(e,s){try{ae.textContent=`Chat with ${s}`;const t=[l.uid,e].sort();g=`chat_${t[0]}_${t[1]}`,S.innerHTML="",O.style.display="flex";const n=F(T,"chats",g,"messages"),o=ee(n,te("timestamp","asc"),ne(50));f=se(o,a=>{a.docChanges().forEach(i=>{if(i.type==="added"){const c=i.doc.data();ve(c)}}),S.scrollTop=S.scrollHeight},a=>{y(a,"chatListener")})}catch(t){y(t,"openChat")}}function ve(e){const s=document.createElement("div");s.className="message",s.classList.add(e.senderId===l.uid?"sent":"received"),s.textContent=e.text,S.appendChild(s)}async function z(){const e=b.value.trim();if(!(e===""||!g||!l))try{p.disabled=!0,p.textContent="Sending...";const s=F(T,"chats",g,"messages");await Q(s,{text:e,senderId:l.uid,timestamp:Z()}),b.value=""}catch(s){y(s,"sendMessage"),C("Send Failed","Failed to send message. Please try again.")}finally{p.disabled=!1,p.textContent="Send"}}function Ee(){O.style.display="none",f&&(f(),f=null),g=null,b.value=""}oe(X,async e=>{console.log("🔐 [USERS] Auth state changed",{userId:e?.uid}),l=e,e?u.length>0&&(d(),fe()):(g=null,f&&(f(),f=null))});document.addEventListener("DOMContentLoaded",()=>{console.log("🚀 [USERS] Initializing enhanced features"),we()});function we(){document.documentElement.style.scrollBehavior="smooth",document.addEventListener("keydown",be),Ce(),Se()}function be(e){(e.ctrlKey||e.metaKey)&&e.key==="k"&&(e.preventDefault(),r&&(r.focus(),r.select())),e.key==="Escape"&&document.activeElement===r&&(r.value="",d())}function Ce(){document.addEventListener("keydown",e=>{e.key==="Tab"&&document.body.classList.add("keyboard-navigation")}),document.addEventListener("mousedown",()=>{document.body.classList.remove("keyboard-navigation")})}function Se(){const e={threshold:.1,rootMargin:"0px 0px -50px 0px"},s=new IntersectionObserver(t=>{t.forEach(n=>{n.isIntersecting&&(n.target.classList.add("fade-in"),s.unobserve(n.target))})},e);document.querySelectorAll(".user-card").forEach(t=>{s.observe(t)})}window.addEventListener("error",e=>{y(e.error,"Global Error")});window.addEventListener("unhandledrejection",e=>{y(e.reason,"Unhandled Promise Rejection")});window.addEventListener("message",e=>{e.data&&e.data.type==="recaptcha-error"&&C("Security Check Failed","The security verification failed. Please refresh the page and try again.")});
