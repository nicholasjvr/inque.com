import{getFunctions as g,httpsCallable as l}from"https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js";import{a as n}from"./auth-DH1qQlSb.js";class h{constructor(){this.functions=g(void 0,"us-central1"),this.log("Cloud Upload Manager initialized with region: us-central1")}log(e,o=null){console.log(`[CLOUD UPLOAD] ${e}`,o||"")}error(e,o=null){console.error(`[CLOUD UPLOAD ERROR] ${e}`,o||"")}async fileToBase64(e){return new Promise((o,i)=>{const t=new FileReader;t.onload=()=>{const r=t.result.split(",")[1];o({name:e.name,type:e.type,size:e.size,data:r})},t.onerror=i,t.readAsDataURL(e)})}async uploadWidgetFiles(e,o,i={}){try{if(this.log("Starting widget upload via Cloud Functions",{fileCount:e.length,slot:o}),!n.currentUser)throw new Error("User must be authenticated to upload files");const t=Array.from(e).map(c=>this.fileToBase64(c)),r=await Promise.all(t);this.log("Files converted to base64",{count:r.length});const s=await l(this.functions,"uploadWidgetFiles")({files:r,slot:o,widgetData:i});return this.log("Widget upload successful",s.data),s.data}catch(t){throw this.error("Widget upload failed",t),new Error(`Upload failed: ${t.message}`)}}async uploadProfilePhoto(e){try{if(this.log("Starting profile photo upload via Cloud Functions"),!n.currentUser)throw new Error("User must be authenticated to upload profile photo");const o=await this.fileToBase64(e);this.log("Profile photo converted to base64");const t=await l(this.functions,"uploadProfilePhoto")({file:o});return this.log("Profile photo upload successful",t.data),t.data}catch(o){throw this.error("Profile photo upload failed",o),new Error(`Profile photo upload failed: ${o.message}`)}}async deleteWidget(e){try{if(this.log("Starting widget deletion via Cloud Functions",{widgetId:e}),!n.currentUser)throw new Error("User must be authenticated to delete widgets");const i=await l(this.functions,"deleteWidget")({widgetId:e});return this.log("Widget deletion successful",i.data),i.data}catch(o){throw this.error("Widget deletion failed",o),new Error(`Widget deletion failed: ${o.message}`)}}async getWidgetDownloadUrls(e){try{if(this.log("Getting widget download URLs via Cloud Functions",{widgetId:e}),!n.currentUser)throw new Error("User must be authenticated to access widget URLs");const i=await l(this.functions,"getWidgetDownloadUrls")({widgetId:e});return this.log("Download URLs retrieved successfully",i.data),i.data}catch(o){throw this.error("Failed to get download URLs",o),new Error(`Failed to get download URLs: ${o.message}`)}}async reuploadWidgetFiles(e,o){try{if(this.log("Starting widget reupload via Cloud Functions",{widgetId:e,fileCount:o.length}),!n.currentUser)throw new Error("User must be authenticated to reupload files");const i=Array.from(o).map(s=>this.fileToBase64(s)),t=await Promise.all(i),u=await l(this.functions,"reuploadWidgetFiles")({widgetId:e,files:t});return this.log("Widget reupload successful",u.data),u.data}catch(i){throw this.error("Widget reupload failed",i),new Error(`Reupload failed: ${i.message}`)}}validateFiles(e){const o=["text/html","text/css","application/javascript","application/json","image/png","image/jpeg","image/gif","image/svg+xml","text/javascript","application/x-javascript"],i=[".html",".js",".css",".png",".jpg",".jpeg",".gif",".svg",".json"];for(const t of e){const r=t.name.slice(t.name.lastIndexOf(".")).toLowerCase();if(!i.includes(r)||t.type&&!o.includes(t.type))return this.error("Invalid file type",{fileName:t.name,fileType:t.type}),!1}return!0}async uploadWithProgress(e,o,i={},t=null){try{if(t&&t(0,"Preparing files..."),!this.validateFiles(e))throw new Error("Invalid file types detected");t&&t(25,"Converting files...");const r=Array.from(e).map(c=>this.fileToBase64(c)),u=await Promise.all(r);t&&t(50,"Uploading to server...");const s=await this.uploadWidgetFiles(e,o,i);return t&&t(100,"Upload complete!"),s}catch(r){throw this.error("Upload with progress failed",r),r}}}const d=new h;window.cloudUploadManager=d;const w=a=>d.uploadProfilePhoto(a),m=a=>d.deleteWidget(a),U=a=>d.getWidgetDownloadUrls(a),W=(a,e)=>d.reuploadWidgetFiles(a,e);export{d as c,m as d,U as g,W as r,w as u};
