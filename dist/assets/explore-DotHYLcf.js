import"./auth-Dy9B-T86.js";/* empty css                       */import{initializeApp as W}from"https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";import{getFirestore as X,getDoc as $,doc as p,updateDoc as L,arrayRemove as S,arrayUnion as k,getDocs as A,collection as z}from"https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";import{getAuth as U,onAuthStateChanged as G}from"https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";import"./profile_banner-HbanVse1.js";import"https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";import"https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";const q={apiKey:"AIzaSyBIZcD-L5jD84hEYLxWOwHTE2iTY6EJ0zI",authDomain:"inque-31cb5.firebaseapp.com",projectId:"inque-31cb5",storageBucket:"inque-31cb5.firebasestorage.app",messagingSenderId:"338722493567",appId:"1:338722493567:web:4c46ecdfe92ddf2a5d5b4a",measurementId:"G-KQT58LWVSK"},H=W(q),f=X(H),K=U(),x=document.getElementById("exploreWidgetList"),a=document.getElementById("widgetSearch"),h=document.getElementById("sortSelect"),E=document.getElementById("categorySelect"),g=document.getElementById("refreshBtn"),D=document.getElementById("loadMoreBtn"),M=document.getElementById("loadMoreContainer"),I=document.getElementById("emptyState"),F=document.getElementById("clearFiltersBtn");let i=null,u=new Set,r=[],d=[],w=[],B=0;const P=12;async function O(){try{console.log("[EXPLORE] Fetching widgets from database");const e=await A(z(f,"widgets")),n=[];return e.forEach(t=>{const o=t.data();console.log("[EXPLORE] Processing widget",{id:t.id,title:o.title,userId:o.userId,fileCount:o.files?.length||0}),n.push({...o,id:t.id,userId:o.userId})}),console.log("[EXPLORE] Total widgets found:",n.length),n}catch(e){return console.error("[EXPLORE] Error fetching widgets:",e),l("Failed to load widgets","error"),[]}}function Y(e){for(let n=e.length-1;n>0;n--){const t=Math.floor(Math.random()*(n+1));[e[n],e[t]]=[e[t],e[n]]}return e}function j(e,n,t){let o=[...e];if(n){const s=n.toLowerCase();o=o.filter(m=>m.title?.toLowerCase().includes(s)||m.description?.toLowerCase().includes(s)||m.userName?.toLowerCase().includes(s))}return t!=="all"&&(o=o.filter(s=>s.category===t||s.tags?.includes(t))),o}function V(e,n){const t=[...e];switch(n){case"recent":return t.sort((o,s)=>new Date(s.createdAt||0)-new Date(o.createdAt||0));case"popular":return t.sort((o,s)=>(s.likes||0)-(o.likes||0));case"name":return t.sort((o,s)=>(o.title||"").localeCompare(s.title||""));case"random":return Y(t);default:return t}}function _(e,n){const t=n*P,o=t+P;return e.slice(t,o)}function R(e){if(!Array.isArray(e)||e.length===0)return null;const n=e.find(t=>t.fileName&&/index\.html?$/i.test(t.fileName));return n||e.find(t=>t.fileName&&/\.html?$/i.test(t.fileName))}async function J(){if(i)try{console.log("[EXPLORE DEBUG] Loading user following list",{userId:i.uid});const e=await $(p(f,"users",i.uid));if(e.exists()){const n=e.data();u=new Set(n.following||[]),console.log("[EXPLORE DEBUG] Following list loaded",{count:u.size})}}catch(e){console.error("[EXPLORE DEBUG] Error loading following list:",e)}}async function Q(e,n){if(!i){l("Please log in to follow users","warning");return}if(i.uid===e){l("You can't follow yourself","warning");return}try{const t=u.has(e);console.log("[EXPLORE DEBUG] Toggling follow",{targetUserId:e,isFollowing:t,currentUserId:i.uid}),t?(await L(p(f,"users",i.uid),{following:S(e)}),await L(p(f,"users",e),{followers:S(i.uid)}),u.delete(e),n.textContent="Follow",n.classList.remove("following"),l("Unfollowed user","info")):(await L(p(f,"users",i.uid),{following:k(e)}),await L(p(f,"users",e),{followers:k(i.uid)}),u.add(e),n.textContent="Following",n.classList.add("following"),l("Now following user!","success"))}catch(t){console.error("[EXPLORE DEBUG] Error toggling follow:",t),l("Error updating follow status","error")}}function Z(e,n){if(!i){l("Please log in to message users","warning");return}if(i.uid===e){l("You can't message yourself","warning");return}console.log("[EXPLORE DEBUG] Opening message modal",{targetUserId:e,targetUserName:n});const t=document.createElement("div");t.className="message-modal",t.innerHTML=`
    <div class="message-modal-content">
      <div class="message-modal-header">
        <h3>ðŸ’¬ Message ${n}</h3>
        <button class="message-modal-close">&times;</button>
      </div>
      <div class="message-modal-body">
        <textarea 
          id="messageText" 
          placeholder="Type your message here..." 
          maxlength="500"
          rows="4"
        ></textarea>
        <div class="message-modal-actions">
          <button class="message-send-btn">Send Message</button>
          <button class="message-cancel-btn">Cancel</button>
        </div>
      </div>
    </div>
  `,document.body.appendChild(t),t.style.display="flex";const o=t.querySelector(".message-modal-close"),s=t.querySelector(".message-cancel-btn"),m=t.querySelector(".message-send-btn"),C=t.querySelector("#messageText"),y=()=>{document.body.removeChild(t)};o.addEventListener("click",y),s.addEventListener("click",y),t.addEventListener("click",v=>{v.target===t&&y()}),m.addEventListener("click",async()=>{const v=C.value.trim();if(!v){l("Please enter a message","warning");return}try{console.log("[EXPLORE DEBUG] Sending message",{to:e,from:i.uid,message:v}),l(`Message sent to ${n}!`,"success"),y()}catch(N){console.error("[EXPLORE DEBUG] Error sending message:",N),l("Error sending message","error")}}),setTimeout(()=>C.focus(),100)}function l(e,n="info"){const t=document.createElement("div");t.className=`explore-toast explore-toast-${n}`,t.textContent=e;const o=document.getElementById("toastContainer");o?o.appendChild(t):document.body.appendChild(t),t.classList.add("fade-in"),setTimeout(()=>{t.parentNode&&(t.style.opacity="0",t.style.transform="translateX(100%)",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))},4e3)}async function ee(){try{if(console.log("[EXPLORE] Initializing explore page"),r=await O(),!r.length){b("No widgets found yet. Check back later!");return}if(r=r.filter(e=>{const n=R(e.files);return n&&n.downloadURL}),!r.length){b("No widgets with previews available yet.");return}c(),ne(),console.log("[EXPLORE] Explore page initialized successfully")}catch(e){console.error("[EXPLORE] Error initializing explore page:",e),b("Failed to load widgets. Please refresh the page.")}}function c(){const e=a?.value||"",n=E?.value||"all",t=h?.value||"recent";d=j(r,e,n),d=V(d,t),B=0,w=[],T()}function T(){if(!d.length){b("No widgets match your current filters.");return}const e=_(d,B);B===0&&(x.innerHTML=""),e.forEach(t=>{const o=te(t);x.appendChild(o)}),w=[...w,...e];const n=w.length<d.length;M.style.display=n?"flex":"none",I.style.display=d.length===0?"flex":"none"}function te(e){const n=R(e.files),t=u.has(e.userId),o=i&&i.uid===e.userId,s=document.createElement("div");return s.className="explore-widget-card",s.innerHTML=`
    <div class="explore-widget-header">
      <h3 class="explore-widget-title">${e.title||"Untitled Widget"}</h3>
      <div class="explore-widget-user">by ${e.userName||"Unknown User"}</div>
    </div>

    <div class="explore-widget-preview">
      ${n&&n.downloadURL?`<iframe src="${n.downloadURL}" sandbox="allow-scripts allow-same-origin" loading="lazy"></iframe>`:'<div class="no-preview">ðŸ“¦ No Preview Available</div>'}
    </div>

    <div class="explore-widget-actions">
      <a href="/?user=${e.userId}" class="explore-profile-link" title="View ${e.userName||"User"}'s profile">ðŸ‘¤ Profile</a>
      ${o?"":`
        <button class="explore-follow-btn ${t?"following":""}"
                data-user-id="${e.userId}"
                title="${t?"Unfollow user":"Follow user"}">
          ${t?"âœ“ Following":"+ Follow"}
        </button>
        <button class="explore-message-btn"
                data-user-id="${e.userId}"
                data-user-name="${e.userName||"Unknown User"}"
                title="Send message">
          ðŸ’¬ Message
        </button>
      `}
    </div>
  `,s}function b(e){x.innerHTML="",M.style.display="none",I.style.display="flex";const n=I.querySelector("p");n&&(n.textContent=e)}function ne(){if(a){let e;a.addEventListener("input",n=>{clearTimeout(e),e=setTimeout(()=>{c()},300)})}h&&h.addEventListener("change",c),E&&E.addEventListener("change",c),g&&g.addEventListener("click",async()=>{g.disabled=!0,g.innerHTML='<span>ðŸ”„</span><span class="btn-text">Loading...</span>';try{r=await O(),c(),l("Widgets refreshed!","success")}catch{l("Failed to refresh widgets","error")}finally{g.disabled=!1,g.innerHTML='<span>ðŸ”„</span><span class="btn-text">Refresh</span>'}}),D&&D.addEventListener("click",()=>{B++,T(),w.length>P&&x.lastElementChild.scrollIntoView({behavior:"smooth",block:"end"})}),F&&F.addEventListener("click",()=>{a&&(a.value=""),h&&(h.value="recent"),E&&(E.value="all"),c()})}ee();G(K,async e=>{console.log("[EXPLORE] Auth state changed",{userId:e?.uid}),i=e,e?(await J(),r.length>0&&c()):(u.clear(),r.length>0&&c())});document.addEventListener("click",e=>{if(e.target.matches(".explore-follow-btn")){e.preventDefault();const n=e.target.dataset.userId;Q(n,e.target)}if(e.target.matches(".explore-message-btn")){e.preventDefault();const n=e.target.dataset.userId,t=e.target.dataset.userName;Z(n,t)}e.target.matches(".explore-widget-preview iframe")&&e.preventDefault()});document.addEventListener("DOMContentLoaded",()=>{console.log("[EXPLORE] Initializing enhanced features"),oe()});function oe(){document.documentElement.style.scrollBehavior="smooth",document.addEventListener("keydown",se),ie(),le()}function se(e){(e.ctrlKey||e.metaKey)&&e.key==="k"&&(e.preventDefault(),a&&(a.focus(),a.select())),e.key==="Escape"&&document.activeElement===a&&(a.value="",c())}function ie(){document.addEventListener("keydown",e=>{e.key==="Tab"&&document.body.classList.add("keyboard-navigation")}),document.addEventListener("mousedown",()=>{document.body.classList.remove("keyboard-navigation")})}function le(){const e={threshold:.1,rootMargin:"0px 0px -50px 0px"},n=new IntersectionObserver(t=>{t.forEach(o=>{o.isIntersecting&&(o.target.classList.add("fade-in"),n.unobserve(o.target))})},e);document.querySelectorAll(".explore-widget-card").forEach(t=>{n.observe(t)})}
