<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Home Page</title>
    <link rel="stylesheet" href="core/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.google.com/recaptcha/enterprise.js?render=6Ldt0YYrAAAAAKyNgAPO8Te96_m5innDHsSkppQc"></script>
  </head>
  <body>
<!-- Sidebar and overlay -->
<div class="sidebar-overlay"></div>
<nav class="sidebar-nav">
  <div class="sidebar-user-info">
    <div class="sidebar-avatar"></div>
    <div class="sidebar-user-details">
      <span class="sidebar-user-name">Guest</span>
      <span class="sidebar-user-email" style="display: none;">guest@example.com</span>
      <span class="sidebar-user-status"><span class="status-dot guest"></span> Not logged in</span>
    </div>
    <button id="sidebarLoginBtn" class="sidebar-auth-btn">Login</button>
    <span id="sidebarUserActions" style="display:none;">
      <button id="sidebarEditProfileBtn" class="sidebar-auth-btn">Edit Profile</button>
      <button id="sidebarLogoutBtn" class="sidebar-auth-btn">Logout</button>
    </span>
  </div>
  
  <!-- Profile Stats Section -->
  <div class="sidebar-stats" style="display: none;">
    <div class="sidebar-stat-item">
      <span class="stat-label">Level</span>
      <span class="stat-value" id="sidebarLvl">?</span>
    </div>
    <div class="sidebar-stat-item">
      <span class="stat-label">Type</span>
      <span class="stat-value" id="sidebarType">?</span>
    </div>
    <div class="sidebar-stat-item">
      <span class="stat-label">Role</span>
      <span class="stat-value" id="sidebarRole">GUEST</span>
    </div>
  </div>

  <!-- Quick Actions Section -->
  <div class="sidebar-quick-actions">
    <h4 class="sidebar-section-title">Quick Actions</h4>
    <button class="quick-action-btn" data-action="newWidget" onclick="event.stopPropagation();">
      <span class="quick-action-icon">+</span>
      <span class="quick-action-text">Add Project to Showcase</span>
    </button>
    <button class="quick-action-btn" data-action="shareProfile" onclick="event.stopPropagation();">
      <span class="quick-action-icon">üì§</span>
      <span class="quick-action-text">Share Profile</span>
    </button>
    <button class="quick-action-btn" data-action="settings" onclick="event.stopPropagation();">
      <span class="quick-action-icon">‚öôÔ∏è</span>
      <span class="quick-action-text">Settings</span>
    </button>
  </div>

  <!-- Notifications Section -->
  <div class="sidebar-notifications" id="sidebarNotifications">
    <div class="notifications-header" id="notificationsHeader">
      <h4 class="sidebar-section-title">
        Notifications
        <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
        <button id="markAllReadBtn" class="mark-all-read-btn" style="display: none;" title="Mark all as read">‚úì</button>
      </h4>
      <button class="notifications-toggle" id="notificationsToggle" title="Expand notifications">
        <span class="toggle-icon">‚ñº</span>
      </button>
    </div>
    <div class="notification-list" id="notificationList">
      <div class="notification-item empty-notification">
        <span class="notification-text">No new notifications</span>
      </div>
    </div>
  </div>

  <!-- UPDATE -->
  <button class="sidebar-close-btn" aria-label="Close sidebar">&times;</button>
  <a href="pages/users.html" class="sidebar-nav-btn">List Users</a>
  <button class="sidebar-nav-btn" data-action="explore">Explore Creations</button>
  <button class="sidebar-nav-btn" data-action="tutorial">My Inventory</button>
  
  <!-- AI Assistant Section -->
  <div class="sidebar-ai-assistant">
    <h4 class="sidebar-section-title">AI Assistant</h4>
    <button class="quick-action-btn" data-action="openChatbot" onclick="event.stopPropagation();">
      <span class="quick-action-icon">ü§ñ</span>
      <span class="quick-action-text">Ask AI Assistant</span>
    </button>
  </div>
</nav>
<header class="site-header">
  <button class="hamburger-menu" aria-label="Open sidebar">&#9776;</button>
  <div id="profile-banner">
    <!-- Profile Avatar Section -->
    <div class="profile-avatar-section">
      <div class="profile-pic-container">
        <div class="profile-status-indicator" id="profileStatusIndicator"></div>
      </div>
      <div class="profile-quick-actions">
        <button class="profile-action-btn" id="editProfileQuickBtn" title="Edit Profile" aria-label="Edit Profile">
          <span class="action-icon">‚úèÔ∏è</span>
        </button>
        <button class="profile-action-btn" id="tutorialBtn" title="Help & Tutorial" aria-label="Help & Tutorial">
          <span class="action-icon">‚ÑπÔ∏è</span>
        </button>
      </div>
    </div>

    <!-- Profile Info Section -->
    <div class="profile-info-section">
        <div class="profile-header">
          <h3 class="profile-name" id="profileName">Welcome</h3>
          <div class="profile-status" id="profileStatus">
            <span class="status-badge guest">Guest</span>
          </div>
          <button id="profileLoginBtn" class="profile-action-btn" style="display: none; margin-left: auto;">Login</button>
        </div>
      
      <p class="profile-bio" id="profileBio">Explore the world of inque</p>
      
      <!-- Profile Stats Row -->
      <div class="profile-stats-row">
        <div class="stat-item">
          <span class="stat-label">Level</span>
          <span class="stat-value" id="profileLvl">?</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Type</span>
          <span class="stat-value" id="profileType">?</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Role</span>
          <span class="stat-value" id="profileRole">GUEST</span>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="profile-navigation">
        <button class="nav-btn primary" data-page="about" title="Learn about inque">
          <span class="nav-icon"></span>
          <span class="nav-text">About</span>
        </button>
        <button class="nav-btn secondary" data-page="explore" title="Explore creations">
          <span class="nav-icon"></span>
          <span class="nav-text">Explore</span>
        </button>
        <button class="nav-btn secondary" data-page="inventory" title="View your items">
          <span class="nav-icon"></span>
          <span class="nav-text">Inventory</span>
        </button>
        <button class="nav-btn secondary" data-page="inventory" title="View your items">
          <span class="nav-icon"></span>
          <span class="nav-text">Blog</span>
        </button>
        <button id="leaveNoteBtn" class="nav-btn secondary" title="Leave a note in the yearbook">
          <span class="nav-icon">üìù</span>
          <span class="nav-text">Leave a Note</span>
        </button>
      </div>
    </div>

    <!-- Collapse/Expand Button -->
    <button id="collapseProfileBtn" class="collapse-profile-btn" aria-label="Toggle profile details">
      <span class="collapse-icon">‚ñº</span>
    </button>
  </div>
</header>

<main>
      <section class="timeline-nav">
        <div class="timeline-3channel">
            <div class="timeline-row top">
              <!--TO DO: MOVE OPPOSITE DIRECTIONS THAN BOTTOM CHANNE timeline-row bottom-->
              <div class="timeline-event" data-id="1">
                <button class="edit-widget-btn" onclick="event.stopPropagation();">Edit</button>
              </div>
              <div class="timeline-event" data-id="3">
                <button class="edit-widget-btn" onclick="event.stopPropagation();">Edit</button>
              </div>
              <div class="timeline-event" data-id="5">
                <button class="edit-widget-btn" onclick="event.stopPropagation();">Edit</button>
              </div>
              <div class="timeline-event" data-id="5">
                <button class="edit-widget-btn" onclick="event.stopPropagation();">Edit</button>
              </div>
              <div class="timeline-event" data-id="5">
                <button class="edit-widget-btn" onclick="event.stopPropagation();">Edit</button>
              </div>
            </div>
            <div class="timeline-row middle">
              <div class="timeline-track"></div>
              <div class="timeline-scrollbar">
                <div class="timeline-scrollbar-handle">
                  <span class="tooltip-text"
                    >Double-click to lock/unlock scroll</span
                  >
                </div>
              </div>
            </div>
            <div class="timeline-row bottom">
              <div class="timeline-event" data-id="2"></div>
              <div class="timeline-event" data-id="4"></div>
              <div class="timeline-event" data-id="4"></div>
              <div class="timeline-event" data-id="5"></div>
              <div class="timeline-event" data-id="5"></div>
            </div>
          </div>
        </section>
      </main>
      <footer>
        <p style="color: #aaa; font-size: 0.8rem;">&copy; 2025 inque. All rights reserved.</p>
      </footer>

      <!-- Only ONE main script, loaded as a module -->
      <script type="module" src="main.js"></script>
              <script type="module" src="scripts/ui/canvas.js"></script>
        <script type="module" src="scripts/widgets/widget-display.js"></script>
        <script type="module" src="scripts/widgets/widget-upload.js"></script>
        <script type="module" src="scripts/widgets/widget-preview.js"></script>
        <script type="module" src="scripts/timeline-manager.js"></script>

      <!-- Widget Preview Modal -->
      <div id="widgetModal" class="modal" style="z-index: 4000;">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Widget Preview</h2>
            <span class="close-button">&times;</span>
          </div>
          <div class="modal-body">
            <iframe id="widgetFrame" src="" frameborder="0"></iframe>
          </div>
        </div>
      </div>

      <!-- Notification Modal -->
      <div id="notificationModal" class="notification-modal">
        <div class="notification-content">
          <p id="notificationMessage">This is a notification!</p>
          <button class="notification-close-btn">&times;</button>
        </div>
      </div>

      <!-- Collaborative Canvas Modal -->
      <div id="canvasModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Collaborative Canvas</h2>
            <span class="close-button canvas-close-button">&times;</span>
          </div>
          <div class="modal-body">
            <canvas id="collabCanvas"></canvas>
            <span class="canvas-tooltip-text"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
      <div class="modal-content auth-modal-content">
        <div class="modal-header">
          <h2 id="authModalTitle" class="modal-title">Welcome to inque</h2>
          <span class="close-button auth-close-button">&times;</span>
        </div>
        <div class="modal-body">
          <!-- Login Form -->
          <form id="loginForm" class="auth-form">
            <div class="form-group">
              <label for="loginEmail">Email Address</label>
              <input type="email" id="loginEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
              <label for="loginPassword">Password</label>
              <div class="password-input-container">
                <input type="password" id="loginPassword" placeholder="Enter your password" required>
                <button type="button" class="password-toggle" id="loginPasswordToggle">üëÅÔ∏è</button>
              </div>
            </div>
            <div class="form-options">
              <label class="checkbox-label">
                <input type="checkbox" id="rememberMe">
                <span class="checkmark"></span>
                Remember me
              </label>
              <a href="#" class="forgot-password" id="forgotPasswordLink">Forgot password?</a>
            </div>
            <button type="submit" class="auth-submit-btn" id="loginSubmitBtn">
              <span class="btn-text">Sign In</span>
              <span class="btn-loader" style="display: none;">‚è≥</span>
            </button>
            
            <div class="social-login">
              <div class="divider">
                <span>or continue with</span>
              </div>
              <div class="social-buttons">
                <button type="button" class="social-btn google-btn" id="googleLoginBtn">
                  <span class="social-icon">üîç</span>
                  Google
                </button>
                <button type="button" class="social-btn github-btn" id="githubLoginBtn">
                  <span class="social-icon">üêô</span>
                  GitHub
                </button>
              </div>
            </div>
            
            <p class="auth-switch">
              Don't have an account? <a href="#" id="showSignUp">Create one</a>
            </p>
          </form>

          <!-- Sign Up Form -->
          <form id="signUpForm" class="auth-form" style="display: none;">
            <div class="form-group">
              <label for="signUpDisplayName">Display Name</label>
              <input type="text" id="signUpDisplayName" placeholder="Enter your display name" required>
            </div>
            <div class="form-group">
              <label for="signUpUsername">Username</label>
              <input type="text" id="signUpUsername" placeholder="Choose a username" required>
              <div class="username-availability" id="usernameAvailability"></div>
            </div>
            <div class="form-group">
              <label for="signUpEmail">Email Address</label>
              <input type="email" id="signUpEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
              <label for="signUpPassword">Password</label>
              <div class="password-input-container">
                <input type="password" id="signUpPassword" placeholder="Create a password" required>
                <button type="button" class="password-toggle" id="signUpPasswordToggle">üëÅÔ∏è</button>
              </div>
              <div class="password-strength" id="passwordStrength"></div>
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm Password</label>
              <div class="password-input-container">
                <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                <button type="button" class="password-toggle" id="confirmPasswordToggle">üëÅÔ∏è</button>
              </div>
            </div>
            <div class="form-group">
              <label for="signUpBio">Bio (Optional)</label>
              <textarea id="signUpBio" placeholder="Tell us about yourself..." rows="2"></textarea>
            </div>
            
            <!-- Social Links Section -->
            <div class="social-links-section">
              <h4>Social Links (Optional)</h4>
              <div class="social-links-grid">
                <div class="form-group">
                  <label for="signUpTwitter">Twitter</label>
                  <input type="url" id="signUpTwitter" placeholder="https://twitter.com/username">
                </div>
                <div class="form-group">
                  <label for="signUpInstagram">Instagram</label>
                  <input type="url" id="signUpInstagram" placeholder="https://instagram.com/username">
                </div>
                <div class="form-group">
                  <label for="signUpGithub">GitHub</label>
                  <input type="url" id="signUpGithub" placeholder="https://github.com/username">
                </div>
                <div class="form-group">
                  <label for="signUpWebsite">Website</label>
                  <input type="url" id="signUpWebsite" placeholder="https://yourwebsite.com">
                </div>
              </div>
            </div>
            
            <div class="form-options">
              <label class="checkbox-label">
                <input type="checkbox" id="agreeTerms" required>
                <span class="checkmark"></span>
                I agree to the <a href="#" class="terms-link">Terms of Service</a> and <a href="#" class="terms-link">Privacy Policy</a>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="emailNotifications" checked>
                <span class="checkmark"></span>
                Receive email notifications
              </label>
            </div>
            <button type="submit" class="auth-submit-btn" id="signUpSubmitBtn">
              <span class="btn-text">Create Account</span>
              <span class="btn-loader" style="display: none;">‚è≥</span>
            </button>
            
            <div class="social-login">
              <div class="divider">
                <span>or sign up with</span>
              </div>
              <div class="social-buttons">
                <button type="button" class="social-btn google-btn" id="googleSignUpBtn">
                  <span class="social-icon">üîç</span>
                  Google
                </button>
                <button type="button" class="social-btn github-btn" id="githubSignUpBtn">
                  <span class="social-icon">üêô</span>
                  GitHub
                </button>
              </div>
            </div>
            <p class="auth-switch">
              Already have an account? <a href="#" id="showLogin">Sign in</a>
            </p>
          </form>

          <!-- Forgot Password Form -->
          <form id="forgotPasswordForm" class="auth-form" style="display: none;">
            <div class="form-group">
              <label for="forgotPasswordEmail">Email Address</label>
              <input type="email" id="forgotPasswordEmail" placeholder="Enter your email" required>
            </div>
            <button type="submit" class="auth-submit-btn" id="forgotPasswordSubmitBtn">
              <span class="btn-text">Send Reset Link</span>
              <span class="btn-loader" style="display: none;">‚è≥</span>
            </button>
            <p class="auth-switch">
              Remember your password? <a href="#" id="showLoginFromForgot">Sign in</a>
            </p>
          </form>
        </div>
      </div>
    </div>

  </body>
</html>

<!-- Toast Notification System -->
<div id="toast-container" class="toast-container">
  <!-- Toast notifications will be dynamically added here -->
</div>

<div id="error-toast" class="error-toast">
  <span id="error-toast-message"></span>
  <button id="error-toast-close">&times;</button>
</div>

<!-- Floating button to expand header if collapsed -->
        <!-- Sidebar functionality is handled in firebase-core.js -->

<script>
  // Profile navigation buttons
  const profileNavBtns = document.querySelectorAll('.nav-btn[data-page]');
  profileNavBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const page = btn.getAttribute('data-page');
      if (!page) return;
      console.log(`Navigating to: ${page}`);
      switch(page) {
        case 'about':
          window.location.href = 'core/personal/about.html';
          break;
        case 'explore':
          window.location.href = 'pages/explore.html';
          break;
        case 'inventory':
          window.location.href = 'pages/inventory.html';
          break;
      }
    });
  });
</script>

<script>
  // Tutorial button functionality
  const tutorialBtn = document.getElementById('tutorialBtn');
  tutorialBtn.addEventListener('click', () => {
    console.log('Tutorial button clicked');
    // For now, just show an alert. In the future, this will open a comprehensive tutorial
    alert('Tutorial feature coming soon! This will explain everything about inque.');
  });
</script>

<script>
  // Profile banner login button behavior
  (function() {
    const loginBtn = document.getElementById('profileLoginBtn');
    if (!loginBtn) return;
    // Defer auth import to avoid blocking paint
    import('./scripts/auth/auth.js').then((mod) => {
      const { auth } = mod;
      const update = () => {
        const user = auth.currentUser;
        loginBtn.style.display = user ? 'none' : 'inline-flex';
      };
      update();
      auth.onAuthStateChanged(() => {
        console.log('[PROFILE LOGIN] Auth state changed');
        update();
      });
      loginBtn.addEventListener('click', () => {
        console.log('[PROFILE LOGIN] Login button clicked');
        // Signal existing auth flow; your auth.js can listen for this
        window.dispatchEvent(new CustomEvent('request-login-from-profile'));
        // Fallback: show the auth modal if listener not wired
        const authModal = document.getElementById('authModal');
        if (authModal) {
          authModal.style.display = 'block';
          document.body.style.overflow = 'hidden';
        }
      });
    }).catch(err => console.warn('[PROFILE LOGIN] Setup failed', err));
  })();
</script>

<script>
// Profile banner collapse/expand logic
(function() {
  const collapseBtn = document.getElementById('collapseProfileBtn');
  const profileBanner = document.getElementById('profile-banner');
  const collapseIcon = collapseBtn.querySelector('.collapse-icon');
  let collapsed = false;

  if (collapseBtn && profileBanner && collapseIcon) {
    collapseBtn.addEventListener('click', () => {
      collapsed = !collapsed;
      if (collapsed) {
        profileBanner.classList.add('collapsed');
        profileBanner.style.maxHeight = '120px';
        profileBanner.style.overflow = 'hidden';
        collapseBtn.classList.add('collapsed');
        collapseIcon.textContent = '‚ñ≤';
      } else {
        profileBanner.classList.remove('collapsed');
        profileBanner.style.maxHeight = 'none';
        profileBanner.style.overflow = 'visible';
        collapseBtn.classList.remove('collapsed');
        collapseIcon.textContent = '‚ñº';
      }
    });
  }
})();
</script>
<!-- Enhanced Profile & Settings Modal -->
<div id="editProfileModal" class="modal">
  <div class="modal-content edit-profile-modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Profile & Settings</h2>
      <span class="close-button edit-profile-close-button">&times;</span>
    </div>
    <div class="modal-body">
      
      <!-- Unified Settings Layout -->
      <div class="settings-container">
        
        <!-- Profile Section -->
        <div class="settings-section">
          <div class="section-header">
            <h3>Profile Information</h3>
            <p class="section-description">Customize your public profile and personal details</p>
          </div>

          <div class="profile-info-grid"></div>
          <div class="profile-settings-grid">
            <!-- Profile Photo -->
            <div class="profile-photo-section">
              <div class="current-photo">
                <div class="photo-preview" id="profilePhotoPreview"></div>
                <div class="photo-overlay">
                  <span class="photo-icon">üì∑</span>
                  <span class="photo-text">Change Photo</span>
                </div>
              </div>
              <input type="file" id="editPhoto" name="editPhoto" accept="image/*" class="photo-input" />
            </div>
            
            <!-- Profile Details -->
            <div class="profile-details">
              <div class="form-group">
                <label for="editProfileName">Display Name</label>
                <input type="text" id="editProfileName" name="editProfileName" placeholder="Enter your display name" required />
              </div>
              <div class="form-group">
                <label for="editProfileBio">Bio</label>
                <textarea id="editProfileBio" name="editProfileBio" placeholder="Tell us about yourself..." rows="3"></textarea>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Account Settings -->
        <div class="settings-section">
          <div class="section-header">
            <h3>‚öôÔ∏è Account Settings</h3>
            <p class="section-description">Manage your account preferences and security</p>
          </div>
          
          <div class="account-settings-grid">
            <div class="setting-item">
              <div class="setting-info">
                <h4>Email Notifications</h4>
                <p>Receive updates about your widgets and activity</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="emailNotifications" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <div class="setting-item">
              <div class="setting-info">
                <h4>Public Profile</h4>
                <p>Allow others to view your profile and widgets</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="publicProfile" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <div class="setting-item">
              <div class="setting-info">
                <h4>Alerts</h4>
                <p>notifications</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="autoSave" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Widget Management Link -->
        <div class="settings-section">
          <div class="section-header">
            <h3>üé® Widget Management</h3>
            <p class="section-description">Manage your widget showcase and uploads</p>
          </div>
          <div class="widget-management-actions">
            <button type="button" class="open-widget-studio-btn" onclick="openWidgetStudio()">
              <span class="btn-icon">üé®</span>
              Open Widget Studio
            </button>
            <p class="section-note">Use the Widget Studio to upload, preview, and manage your interactive widgets</p>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="settings-actions">
          <button type="submit" class="primary-btn" id="saveAllSettings">
            <span class="btn-icon">üíæ</span>
            Save All Changes
          </button>
          <button type="button" class="secondary-btn" id="testCloudFunctions">
            <span class="btn-icon">üîß</span>
            Test Cloud Functions
          </button>
          <button type="button" class="secondary-btn edit-profile-close-button">
            <span class="btn-icon">‚úï</span>
            Cancel
          </button>
        </div>
        
      </div>
      
    </div>
  </div>
</div>

<!-- Widget Studio Modal -->
<div id="widgetStudioModal" class="modal">
  <div class="modal-content widget-studio-modal-content">
    <div class="modal-header">
      <h2 class="modal-title">üé® Widget Studio</h2>
      <span class="close-button widget-studio-close-button">&times;</span>
    </div>
    <div class="modal-body">
      
      <!-- Widget Studio Layout -->
      <div class="widget-studio-container">
        
        <!-- Widget Showcase Grid -->
        <div class="widget-showcase-grid">
          <div class="widget-slot" data-slot="1">
            <div class="slot-header">
              <h4>Slot 1</h4>
              <span class="slot-status">Available</span>
            </div>
            <div class="widget-slot-content">
              <div class="widget-upload-area">
                <input type="file" class="widget-file-input" data-slot="1" multiple accept=".html,.js,.css,.png,.jpg,.jpeg,.gif,.svg,.json,.webp">
                <div class="upload-placeholder">
                  <span class="upload-icon">üìÅ</span>
                  <p>Drop files here or click to upload</p>
                </div>
              </div>
              <div class="widget-slot-info">
                <input type="text" class="widget-title-input" data-slot="1" placeholder="Widget Title">
                <textarea class="widget-desc-input" data-slot="1" placeholder="Widget Description" rows="2"></textarea>
              </div>
              <div class="widget-slot-actions">
                <button type="button" class="preview-widget-btn" data-slot="1" title="Preview files">
                  <span class="btn-icon">üëÅÔ∏è</span>
                  Preview
                </button>
                <button class="upload-widget-btn" data-slot="1">Upload to Slot 1</button>
              </div>
            </div>
          </div>
          
          <div class="widget-slot" data-slot="2">
            <div class="slot-header">
              <h4>Slot 2</h4>
              <span class="slot-status">Available</span>
            </div>
            <div class="widget-slot-content">
              <div class="widget-upload-area">
                <input type="file" class="widget-file-input" data-slot="2" multiple accept=".html,.js,.css,.png,.jpg,.jpeg,.gif,.svg,.json,.webp">
                <div class="upload-placeholder">
                  <span class="upload-icon">üìÅ</span>
                  <p>Drop files here or click to upload</p>
                </div>
              </div>
              <div class="widget-slot-info">
                <input type="text" class="widget-title-input" data-slot="2" placeholder="Widget Title">
                <textarea class="widget-desc-input" data-slot="2" placeholder="Widget Description" rows="2"></textarea>
              </div>
              <div class="widget-slot-actions">
                <button type="button" class="preview-widget-btn" data-slot="2" title="Preview files">
                  <span class="btn-icon">üëÅÔ∏è</span>
                  Preview
                </button>
                <button class="upload-widget-btn" data-slot="2">Upload to Slot 2</button>
              </div>
            </div>
          </div>
          
          <div class="widget-slot" data-slot="3">
            <div class="slot-header">
              <h4>Slot 3</h4>
              <span class="slot-status">Available</span>
            </div>
            <div class="widget-slot-content">
              <div class="widget-upload-area">
                <input type="file" class="widget-file-input" data-slot="3" multiple accept=".html,.js,.css,.png,.jpg,.jpeg,.gif,.svg,.json,.webp">
                <div class="upload-placeholder">
                  <span class="upload-icon">üìÅ</span>
                  <p>Drop files here or click to upload</p>
                </div>
              </div>
              <div class="widget-slot-info">
                <input type="text" class="widget-title-input" data-slot="3" placeholder="Widget Title">
                <textarea class="widget-desc-input" data-slot="3" placeholder="Widget Description" rows="2"></textarea>
              </div>
              <div class="widget-slot-actions">
                <button type="button" class="preview-widget-btn" data-slot="3" title="Preview files">
                  <span class="btn-icon">üëÅÔ∏è</span>
                  Preview
                </button>
                <button class="upload-widget-btn" data-slot="3">Upload to Slot 3</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Studio Actions -->
        <div class="studio-actions">
          <button type="button" class="secondary-btn widget-studio-close-button">
            <span class="btn-icon">‚úï</span>
            Close Studio
          </button>
        </div>
        
      </div>
      
    </div>
  </div>
</div>

<!-- AI Chatbot Modal -->
<div id="chatbotModal" class="modal">
  <div class="modal-content chatbot-modal-content">
    <div class="modal-header">
      <h2 class="modal-title">ü§ñ AI Assistant</h2>
      <span class="close-button chatbot-close-button">&times;</span>
    </div>
    <div class="modal-body">
      <div class="chatbot-container">
        <div class="chat-messages" id="chatMessages">
          <div class="message ai-message">
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
              <p>Hello! I'm your AI assistant. I can help you understand the features of this application, answer questions about widgets, and guide you through the platform. What would you like to know?</p>
            </div>
          </div>
        </div>
        
        <div class="chat-input-container">
          <input type="text" id="chatInput" class="chat-input" placeholder="Ask me anything about the application..." maxlength="500">
          <button id="sendChatBtn" class="send-chat-btn">
            <span class="btn-icon">üì§</span>
            Send
          </button>
        </div>
        
        <div class="chat-suggestions">
          <p class="suggestions-title">Quick questions you can ask:</p>
          <div class="suggestion-chips">
            <button class="suggestion-chip" data-question="What is this application about?">What is this application about?</button>
            <button class="suggestion-chip" data-question="How do I upload a widget?">How do I upload a widget?</button>
            <button class="suggestion-chip" data-question="What are the main features?">What are the main features?</button>
            <button class="suggestion-chip" data-question="How do I edit my profile?">How do I edit my profile?</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { db, auth, storage } from "../scripts/auth/auth.js";
import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";
import { uploadWidgetFiles } from '../scripts/upload/cloud-upload.js';
import { saveWidgetSlotMetadata } from '../scripts/widgets/project-manager.js';

const editProfileModal = document.getElementById('editProfileModal');
const editProfileForm = document.getElementById('editProfileForm');
const editProfileCloseBtns = document.querySelectorAll('.edit-profile-close-button');
const editProfileQuickBtn = document.getElementById('editProfileQuickBtn');
const editProfileName = document.getElementById('editProfileName');
const editProfileBio = document.getElementById('editProfileBio');
const editPhotoInput = document.getElementById('editPhoto');
let currentPhotoURL = null;

// Enhanced profile photo handling
const profilePhotoPreview = document.getElementById('profilePhotoPreview');
const currentPhoto = document.querySelector('.current-photo');

// Set up photo click handler
if (currentPhoto) {
  currentPhoto.addEventListener('click', () => {
    editPhotoInput.click();
  });
}

// Wire close buttons for the Edit Profile modal
if (editProfileCloseBtns && editProfileCloseBtns.length) {
  editProfileCloseBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      console.log('[EDIT PROFILE] Close button clicked');
      if (editProfileModal) {
        editProfileModal.style.display = 'none';
        document.body.style.overflow = '';
        console.log('[EDIT PROFILE] Modal closed via close button');
      }
    });
  });
}

// Widget Studio Modal Functions
function openWidgetStudio() {
  console.log('[WIDGET STUDIO] Opening widget studio modal...');
  const widgetStudioModal = document.getElementById('widgetStudioModal');
  if (widgetStudioModal) {
    widgetStudioModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    console.log('[WIDGET STUDIO] Modal opened successfully');
    
    // Initialize widget studio components
    initializeWidgetStudio();
  } else {
    console.error('[WIDGET STUDIO] Modal not found');
  }
}

function initializeWidgetStudio() {
  console.log('[WIDGET STUDIO] Initializing widget studio components...');
  
  // Check if widget upload areas exist
  const uploadAreas = document.querySelectorAll('.widget-upload-area');
  console.log(`[WIDGET STUDIO] Found ${uploadAreas.length} widget upload areas`);
  
  // Check if preview buttons exist
  const previewBtns = document.querySelectorAll('.preview-widget-btn');
  console.log(`[WIDGET STUDIO] Found ${previewBtns.length} preview buttons`);
  
  // Check if upload buttons exist
  const uploadBtns = document.querySelectorAll('.upload-widget-btn');
  console.log(`[WIDGET STUDIO] Found ${uploadBtns.length} upload buttons`);
  
  console.log('[WIDGET STUDIO] Widget studio initialization complete');
}

// Wire close buttons for the Widget Studio modal
const widgetStudioCloseBtns = document.querySelectorAll('.widget-studio-close-button');
if (widgetStudioCloseBtns && widgetStudioCloseBtns.length) {
  widgetStudioCloseBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      console.log('[WIDGET STUDIO] Close button clicked');
      const widgetStudioModal = document.getElementById('widgetStudioModal');
      if (widgetStudioModal) {
        widgetStudioModal.style.display = 'none';
        document.body.style.overflow = '';
        console.log('[WIDGET STUDIO] Modal closed via close button');
      }
    });
  });
}

// Navigate to full-page editor from quick and sidebar buttons
const sidebarEditProfileBtn = document.getElementById('sidebarEditProfileBtn');
function goToFullProfileEditor() {
  if (auth && auth.currentUser) {
    console.log('[EDIT PROFILE] Navigating to full-page editor');
    window.location.href = 'pages/profile-edit.html';
  } else {
    console.log('[EDIT PROFILE] Not authenticated, opening auth modal');
    const authModal = document.getElementById('authModal');
    if (authModal) {
      authModal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
  }
}
if (editProfileQuickBtn) {
  editProfileQuickBtn.addEventListener('click', (e) => {
    e.preventDefault();
    goToFullProfileEditor();
  });
}
if (sidebarEditProfileBtn) {
  sidebarEditProfileBtn.addEventListener('click', (e) => {
    e.preventDefault();
    goToFullProfileEditor();
  });
}

// Live image preview
const photoPreview = document.createElement('img');
photoPreview.style.display = 'none';
photoPreview.style.width = '80px';
photoPreview.style.height = '80px';
photoPreview.style.borderRadius = '50%';
photoPreview.style.marginTop = '10px';
editPhotoInput.parentNode.appendChild(photoPreview);

// Pre-fill form with current user info
async function prefillProfileForm() {
  const user = auth.currentUser;
  if (!user) return;
  const userDoc = await getDoc(doc(db, 'users', user.uid));
  if (userDoc.exists()) {
    const data = userDoc.data();
    editProfileName.value = data.name || '';
    editProfileBio.value = data.bio || '';
    currentPhotoURL = data.photoURL || '';
    
    // Update profile photo preview
    if (profilePhotoPreview) {
      if (currentPhotoURL) {
        profilePhotoPreview.style.backgroundImage = `url(${currentPhotoURL})`;
      } else {
        profilePhotoPreview.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      }
    }
    
    if (currentPhotoURL) {
      photoPreview.src = currentPhotoURL;
      photoPreview.style.display = 'block';
    } else {
      photoPreview.style.display = 'none';
    }
    
    // Load user settings
    if (data.settings) {
      const emailNotificationsSetting = document.getElementById('emailNotifications');
      const publicProfileSetting = document.getElementById('publicProfile');
      const autoSaveSetting = document.getElementById('autoSave');
      const sidebarSlidingSetting = document.getElementById('sidebarSliding');
      
      if (emailNotificationsSetting) {
        emailNotificationsSetting.checked = data.settings.emailNotifications !== false;
      }
      if (publicProfileSetting) {
        publicProfileSetting.checked = data.settings.publicProfile !== false;
      }
      if (autoSaveSetting) {
        autoSaveSetting.checked = data.settings.autoSave !== false;
      }
      if (sidebarSlidingSetting) {
        sidebarSlidingSetting.checked = data.settings.sidebarSliding !== false;
      }
    }
  }
}

// Test Cloud Functions connection
async function testCloudFunctions() {
  console.log('[DEBUG] Testing Cloud Functions connection...');
  try {
    const { testConnection } = await import('./scripts/upload/cloud-upload.js');
    const result = await testConnection();
    console.log('[DEBUG] Cloud Functions test result:', result);
    return result;
  } catch (error) {
    console.error('[DEBUG] Cloud Functions test failed:', error);
    return { success: false, error: error.message };
  }
}

// Comprehensive debug function
async function debugCloudFunctions() {
  console.log('[DEBUG] Starting comprehensive Cloud Functions debug...');
  
  try {
    // Test 1: Check if Firebase is initialized
    console.log('[DEBUG] Test 1: Checking Firebase initialization...');
    const { auth } = await import('./core/firebase-core.js');
    console.log('[DEBUG] Firebase auth available:', !!auth);
    
    // Test 2: Check if user is authenticated
    console.log('[DEBUG] Test 2: Checking authentication...');
    const user = auth.currentUser;
    console.log('[DEBUG] User authenticated:', !!user);
    if (user) {
      console.log('[DEBUG] User ID:', user.uid);
    }
    
    // Test 3: Test Cloud Functions connection
    console.log('[DEBUG] Test 3: Testing Cloud Functions...');
    const { testConnection } = await import('./scripts/upload/cloud-upload.js');
    const cfResult = await testConnection();
    console.log('[DEBUG] Cloud Functions test result:', cfResult);
    
    return {
      success: cfResult,
      firebaseInitialized: !!auth,
      userAuthenticated: !!user,
      cloudFunctionsWorking: cfResult
    };
  } catch (error) {
    console.error('[DEBUG] Debug failed:', error);
    return { 
      success: false, 
      error: error.message,
      stack: error.stack 
    };
  }
}

// Add test button event listener
const testCloudFunctionsBtn = document.getElementById('testCloudFunctions');
if (testCloudFunctionsBtn) {
  testCloudFunctionsBtn.addEventListener('click', async () => {
    console.log('[DEBUG] Test Cloud Functions button clicked');
    const result = await debugCloudFunctions();
    console.log('[DEBUG] Comprehensive debug result:', result);
    
    if (result.success) {
      alert('‚úÖ All systems working!\n\nFirebase: ‚úÖ\nAuth: ‚úÖ\nCloud Functions: ‚úÖ');
    } else {
      let errorMsg = '‚ùå Debug failed:\n\n';
      if (!result.firebaseInitialized) errorMsg += 'Firebase: ‚ùå\n';
      if (!result.userAuthenticated) errorMsg += 'Auth: ‚ùå\n';
      if (!result.cloudFunctionsWorking) errorMsg += 'Cloud Functions: ‚ùå\n';
      if (result.error) errorMsg += '\nError: ' + result.error;
      
      alert(errorMsg);
    }
  });
}

// Widget upload functionality is now handled by scripts/widgets/widget-upload.js

window.addEventListener('click', (e) => {
  if (e.target === editProfileModal) {
    console.log('[EDIT PROFILE] Modal backdrop clicked');
    if (editProfileModal) {
      editProfileModal.style.display = 'none';
      document.body.style.overflow = '';
      console.log('[EDIT PROFILE] Modal closed via backdrop');
    }
  }
});

// Live image preview on file select
editPhotoInput.addEventListener('change', function() {
  if (this.files && this.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      // Update both previews
      photoPreview.src = e.target.result;
      photoPreview.style.display = 'block';
      
      if (profilePhotoPreview) {
        profilePhotoPreview.style.backgroundImage = `url(${e.target.result})`;
      }
    };
    reader.readAsDataURL(this.files[0]);
  } else if (currentPhotoURL) {
    photoPreview.src = currentPhotoURL;
    photoPreview.style.display = 'block';
    
    if (profilePhotoPreview) {
      profilePhotoPreview.style.backgroundImage = `url(${currentPhotoURL})`;
    }
  } else {
    photoPreview.style.display = 'none';
    
    if (profilePhotoPreview) {
      profilePhotoPreview.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }
  }
});

// Save all settings functionality
const saveAllSettingsBtn = document.getElementById('saveAllSettings');

if (saveAllSettingsBtn) {
  saveAllSettingsBtn.addEventListener('click', async () => {
    console.log('[EDIT PROFILE] Save button clicked');
    const user = auth.currentUser;
    if (!user) {
      console.log('[EDIT PROFILE] No user logged in');
      return;
    }
    
    // Show loading state
    saveAllSettingsBtn.textContent = 'Saving...';
    saveAllSettingsBtn.disabled = true;
    
    try {
      const name = editProfileName.value.trim();
      const bio = editProfileBio.value.trim();
      let photoURL = currentPhotoURL;
      
      // If a new photo is selected, upload it
      if (editPhotoInput.files && editPhotoInput.files[0]) {
        try {
          console.log('[EDIT PROFILE] Uploading profile photo via Cloud Functions');
          
          // Import and use Cloud Functions for profile photo upload
          const { uploadProfilePhoto } = await import('./scripts/upload/cloud-upload.js');
          const result = await uploadProfilePhoto(editPhotoInput.files[0]);
          
          photoURL = result.photoURL;
          console.log('Profile photo uploaded successfully via Cloud Functions');
        } catch (storageError) {
          console.warn('Failed to upload profile photo via Cloud Functions:', storageError);
          // Continue without photo upload - don't fail the entire profile update
        }
      }
      
      // Get settings values
      const emailNotifications = document.getElementById('emailNotifications')?.checked || false;
      const publicProfile = document.getElementById('publicProfile')?.checked || false;
      const autoSave = document.getElementById('autoSave')?.checked || false;
      const sidebarSliding = document.getElementById('sidebarSliding')?.checked || false;
      
      // Update Firestore with all settings
      await updateDoc(doc(db, 'users', user.uid), {
        name,
        bio,
        photoURL,
        settings: {
          emailNotifications,
          publicProfile,
          autoSave,
          sidebarSliding,
          updatedAt: new Date()
        }
      });
      
      // Show success message
      showToast('All settings saved successfully! üéâ', 'success');
      
      // Close modal after a short delay
      setTimeout(() => {
        editProfileModal.style.display = 'none';
        document.body.style.overflow = '';
        // Update UI dynamically instead of reloading
        updateProfileDisplay();
      }, 1500);
      
    } catch (error) {
      console.error('Failed to save settings:', error);
      showToast('Failed to save settings. Please try again.', 'error');
    } finally {
      // Reset button state
      saveAllSettingsBtn.textContent = 'Save All Changes';
      saveAllSettingsBtn.disabled = false;
    }
  });
}

// Update profile display dynamically
function updateProfileDisplay() {
  // Update profile banner if it exists
  const profileName = document.querySelector('.profile-name');
  const profileBio = document.querySelector('.profile-bio');
  const profilePhoto = document.querySelector('.profile-photo');
  
  if (profileName && editProfileName) {
    profileName.textContent = editProfileName.value.trim();
  }
  
  if (profileBio && editProfileBio) {
    profileBio.textContent = editProfileBio.value.trim();
  }
  
  // Update sidebar user info if it exists
  const sidebarUserName = document.querySelector('.sidebar-user-name');
  if (sidebarUserName && editProfileName) {
    sidebarUserName.textContent = editProfileName.value.trim();
  }
  
  // Update profile photo if a new one was uploaded
  if (editPhotoInput.files && editPhotoInput.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      if (profilePhoto) {
        profilePhoto.style.backgroundImage = `url(${e.target.result})`;
      }
      if (sidebarAvatar) {
        sidebarAvatar.style.backgroundImage = `url(${e.target.result})`;
      }
    };
    reader.readAsDataURL(editPhotoInput.files[0]);
  }
}

// Legacy form handler (for backward compatibility)
if (editProfileForm) {
  editProfileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) return;
    const name = editProfileName.value.trim();
    const bio = editProfileBio.value.trim();
    let photoURL = currentPhotoURL;
    
    // If a new photo is selected, upload it
    if (editPhotoInput.files && editPhotoInput.files[0]) {
      try {
        console.log('[EDIT PROFILE] Uploading profile photo via Cloud Functions (legacy)');
        
        // Import and use Cloud Functions for profile photo upload
        const { uploadProfilePhoto } = await import('./scripts/upload/cloud-upload.js');
        const result = await uploadProfilePhoto(editPhotoInput.files[0]);
        
        photoURL = result.photoURL;
        console.log('Profile photo uploaded successfully via Cloud Functions (legacy)');
      } catch (storageError) {
        console.warn('Failed to upload profile photo via Cloud Functions (legacy):', storageError);
        // Continue without photo upload - don't fail the entire profile update
      }
    }
    
    try {
      // Update Firestore
      await updateDoc(doc(db, 'users', user.uid), {
        name,
        bio,
        photoURL
      });
      editProfileModal.style.display = 'none';
      document.body.style.overflow = '';
      showToast('Profile updated successfully! üéâ', 'success');
      // Update UI dynamically instead of reloading
      updateProfileDisplay();
    } catch (error) {
      console.error('Failed to update profile:', error);
      alert('Failed to update profile. Please try again.');
    }
  });
}

// ===== AI CHATBOT FUNCTIONALITY =====
console.log('[CHATBOT] Initializing AI chatbot...');

// Chatbot state
let chatHistory = [];

// Initialize chatbot when modal opens
function initializeChatbot() {
  console.log('[CHATBOT] Initializing chatbot components...');
  
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendChatBtn = document.getElementById('sendChatBtn');
  
  if (!chatMessages || !chatInput || !sendChatBtn) {
    console.error('[CHATBOT] Required chatbot elements not found');
    return;
  }
  
  // Add event listeners
  sendChatBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  // Add suggestion chip event listeners
  const suggestionChips = document.querySelectorAll('.suggestion-chip');
  suggestionChips.forEach(chip => {
    chip.addEventListener('click', () => {
      const question = chip.textContent.trim();
      chatInput.value = question;
      sendMessage();
    });
  });
  
  console.log('[CHATBOT] Chatbot initialized successfully');
}

// Send a message to the AI
async function sendMessage() {
  const chatInput = document.getElementById('chatInput');
  const message = chatInput.value.trim();
  
  if (!message || isTyping) return;
  
  console.log('[CHATBOT] Sending message:', message);
  
  // Add user message to chat
  addMessage(message, 'user');
  chatInput.value = '';
  
  // Show typing indicator
  showTypingIndicator();
  
  try {
    // Get AI response using Genkit
    const response = await getAIResponse(message);
    
    // Remove typing indicator and add AI response
    removeTypingIndicator();
    addMessage(response, 'ai');
    
    // Add to chat history
    chatHistory.push({ role: 'user', content: message });
    chatHistory.push({ role: 'assistant', content: response });
    
  } catch (error) {
    console.error('[CHATBOT] Error getting AI response:', error);
    removeTypingIndicator();
    addMessage('Sorry, I encountered an error. Please try again.', 'ai');
  }
}

// Get AI response using Genkit
async function getAIResponse(message) {
  console.log('[CHATBOT] Getting AI response for:', message);
  
  try {
    // Import configuration and Google AI
    const { AI_CONFIG, getApiKey, isAIConfigured } = await import('./config/ai-config.js');
    const { GoogleGenerativeAI } = await import('@google/generative-ai');
    
    // Check if AI is properly configured
    if (!isAIConfigured()) {
      console.warn('[CHATBOT] AI not configured, using fallback responses');
      throw new Error('AI not configured');
    }
    
    // Initialize Google AI with API key from config
    const genAI = new GoogleGenerativeAI(getApiKey());
    
    // Create a simple prompt for application features
    const prompt = `You are a helpful AI assistant for a web application. The user asked: "${message}"
    
    This application has the following features:
    - User authentication and profiles
    - Widget upload and management system
    - Interactive canvas for drawing and collaboration
    - Timeline-based project management
    - Social features and user interactions
    - File upload and storage capabilities
    
    Please provide a helpful, friendly response explaining how these features work or answering the user's question. Keep responses concise but informative (max ${AI_CONFIG.MAX_RESPONSE_LENGTH} characters).`;
    
    // Get response from Gemini
    const model = genAI.getGenerativeModel({ model: AI_CONFIG.MODEL });
    const result = await model.generateContent(prompt);
    const response = result.response.text();
    
    console.log('[CHATBOT] AI response received:', response);
    return response;
    
  } catch (error) {
    console.error('[CHATBOT] Error with AI integration:', error);
    
    // Use fallback responses from config
    try {
      const { AI_CONFIG } = await import('./config/ai-config.js');
      
      // Check if message contains keywords for fallback responses
      const lowerMessage = message.toLowerCase();
      for (const [keyword, response] of Object.entries(AI_CONFIG.FALLBACK_RESPONSES)) {
        if (lowerMessage.includes(keyword)) {
          return response;
        }
      }
      
      return AI_CONFIG.FALLBACK_RESPONSES.default;
    } catch (configError) {
      console.error('[CHATBOT] Error loading config:', configError);
      return 'I\'m here to help you understand this application! You can ask me about features, widgets, the canvas, profiles, or how to use different parts of the platform.';
    }
  }
}

// Add a message to the chat
function addMessage(content, sender) {
  const chatMessages = document.getElementById('chatMessages');
  if (!chatMessages) return;
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}-message`;
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = sender === 'ai' ? 'ü§ñ' : 'üë§';
  
  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  
  const messageText = document.createElement('p');
  messageText.textContent = content;
  
  messageContent.appendChild(messageText);
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(messageContent);
  
  chatMessages.appendChild(messageDiv);
  
  // Scroll to bottom
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  console.log(`[CHATBOT] Added ${sender} message:`, content);
}

// Send message to AI and get response
async function sendMessage() {
  const chatInput = document.getElementById('chatInput');
  const message = chatInput.value.trim();
  
  if (!message || isTyping) return;
  
  console.log('[CHATBOT] Sending message:', message);
  
  // Add user message to chat
  addMessage('user', message);
  
  // Clear input
  chatInput.value = '';
  
  // Show typing indicator
  showTypingIndicator();
  
  try {
    // Get AI response
    const response = await getAIResponse(message);
    
    // Remove typing indicator
    removeTypingIndicator();
    
    // Add AI response
    addMessage('ai', response);
    
    console.log('[CHATBOT] AI response received:', response);
  } catch (error) {
    console.error('[CHATBOT] Error getting AI response:', error);
    
    // Remove typing indicator
    removeTypingIndicator();
    
    // Show error message
    addMessage('ai', 'Sorry, I encountered an error. Please try again or ask a different question.');
  }
}

// Get AI response using Genkit API
async function getAIResponse(message) {
  try {
    // Import AI config
    const { AI_CONFIG } = await import('./config/ai-config.js');
    
    if (!AI_CONFIG.GOOGLE_AI_API_KEY) {
      throw new Error('AI API key not configured');
    }
    
    console.log('[CHATBOT] Making API request to Google AI...');
    
    // Make request to Google AI API (Gemini)
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${AI_CONFIG.MODEL}:generateContent?key=${AI_CONFIG.GOOGLE_AI_API_KEY}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `You are a helpful AI assistant for a web application called "inque". This application has the following features:
            
            - User profiles and authentication
            - Widget management (upload, preview, display)
            - Interactive canvas for drawing and collaboration
            - Timeline management
            - Social features
            - Project management
            
            The user is asking: "${message}"
            
            Please provide a helpful, friendly response that explains features or answers their question. Keep responses concise (under 200 words) and focus on being helpful. If they ask about something not in the app, politely redirect them to the app's features.`
          }]
        }]
      })
    });
    
    if (!response.ok) {
      throw new Error(`API request failed: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
      const aiResponse = data.candidates[0].content.parts[0].text;
      console.log('[CHATBOT] AI response received from API');
      return aiResponse;
    } else {
      throw new Error('Invalid response format from AI API');
    }
    
  } catch (error) {
    console.error('[CHATBOT] Error in getAIResponse:', error);
    
    // Fallback to predefined responses
    const fallbackResponses = {
      'what is this application about': 'This is "inque" - a web application for creative collaboration! It includes user profiles, widget management, interactive canvas, timeline management, and social features.',
      'how do i upload a widget': 'To upload a widget, click on "Widget Studio" in your profile settings. You can upload HTML, CSS, and JavaScript files, preview them, and then publish them to your profile.',
      'what are the main features': 'The main features include: user profiles, widget management, interactive canvas for drawing, timeline management, social features, and project management tools.',
      'how do i edit my profile': 'Click on your profile picture or name to open the profile editor. You can change your name, bio, profile picture, and other settings there.',
      'help': 'I can help you understand the features of this application! Ask me about widgets, the canvas, profiles, or any other aspect of the platform.'
    };
    
    const lowerMessage = message.toLowerCase();
    for (const [key, response] of Object.entries(fallbackResponses)) {
      if (lowerMessage.includes(key)) {
        return response;
      }
    }
    
    return 'I\'m here to help you understand this application! You can ask me about features, widgets, the canvas, profiles, or how to use different parts of the platform.';
  }
}

// Initialize chatbot functionality
function initializeChatbot() {
  console.log('[CHATBOT] Initializing chatbot...');
  
  const chatInput = document.getElementById('chatInput');
  const sendChatBtn = document.getElementById('sendChatBtn');
  const suggestionChips = document.querySelectorAll('.suggestion-chip');
  
  if (!chatInput || !sendChatBtn) {
    console.error('[CHATBOT] Required chatbot elements not found');
    return;
  }
  
  // Send message on Enter key
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
  
  // Send message on button click
  sendChatBtn.addEventListener('click', sendMessage);
  
  // Handle suggestion chips
  suggestionChips.forEach(chip => {
    chip.addEventListener('click', () => {
      const question = chip.getAttribute('data-question');
      if (question) {
        console.log('[CHATBOT] Suggestion chip clicked:', question);
        document.getElementById('chatInput').value = question;
        sendMessage();
      }
    });
  });
  
  console.log('[CHATBOT] Chatbot initialized successfully');
}

// Show typing indicator
function showTypingIndicator() {
  isTyping = true;
  const chatMessages = document.getElementById('chatMessages');
  if (!chatMessages) return;
  
  const typingDiv = document.createElement('div');
  typingDiv.className = 'message ai-message typing';
  typingDiv.id = 'typingIndicator';
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = 'ü§ñ';
  
  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  
  const messageText = document.createElement('p');
  messageText.textContent = 'Thinking...';
  
  messageContent.appendChild(messageText);
  typingDiv.appendChild(avatar);
  typingDiv.appendChild(messageContent);
  
  chatMessages.appendChild(typingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  console.log('[CHATBOT] Showing typing indicator');
}

// Remove typing indicator
function removeTypingIndicator() {
  isTyping = false;
  const typingIndicator = document.getElementById('typingIndicator');
  if (typingIndicator) {
    typingIndicator.remove();
    console.log('[CHATBOT] Removed typing indicator');
  }
}

// Open chatbot modal
function openChatbot() {
  console.log('[CHATBOT] Opening chatbot modal...');
  const chatbotModal = document.getElementById('chatbotModal');
  if (chatbotModal) {
    chatbotModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Initialize chatbot when modal opens
    setTimeout(() => {
      initializeChatbot();
    }, 100);
    
    console.log('[CHATBOT] Chatbot modal opened successfully');
  } else {
    console.error('[CHATBOT] Chatbot modal not found');
  }
}

// Close chatbot modal
function closeChatbot() {
  console.log('[CHATBOT] Closing chatbot modal...');
  const chatbotModal = document.getElementById('chatbotModal');
  if (chatbotModal) {
    chatbotModal.style.display = 'none';
    document.body.style.overflow = '';
    console.log('[CHATBOT] Chatbot modal closed successfully');
  }
}

// Wire up chatbot close buttons
document.addEventListener('DOMContentLoaded', () => {
  const chatbotCloseBtns = document.querySelectorAll('.chatbot-close-button');
  chatbotCloseBtns.forEach(btn => {
    btn.addEventListener('click', closeChatbot);
  });
  
  // Close on backdrop click
  const chatbotModal = document.getElementById('chatbotModal');
  if (chatbotModal) {
    chatbotModal.addEventListener('click', (e) => {
      if (e.target === chatbotModal) {
        closeChatbot();
      }
    });
  }
  
  console.log('[CHATBOT] Chatbot event listeners attached');
});

// Add message to chat
function addMessage(sender, content) {
  const chatMessages = document.getElementById('chatMessages');
  if (!chatMessages) return;
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}-message`;
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
  
  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  
  const messageText = document.createElement('p');
  messageText.textContent = content;
  
  messageContent.appendChild(messageText);
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(messageContent);
  
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  console.log(`[CHATBOT] Added ${sender} message:`, content);
}

// Global typing state
let isTyping = false;

console.log('[CHATBOT] AI chatbot functionality loaded');
</script>


