<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Home Page</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.google.com/recaptcha/enterprise.js?render=6Ldt0YYrAAAAAKyNgAPO8Te96_m5innDHsSkppQc"></script>
  </head>
  <body>
<!-- Sidebar and overlay -->
<div class="sidebar-overlay"></div>
<nav class="sidebar-nav">
  <div class="sidebar-user-info">
    <div class="sidebar-avatar"></div>
    <div class="sidebar-user-details">
      <span class="sidebar-user-name">Guest</span>
      <span class="sidebar-user-email" style="display: none;">guest@example.com</span>
      <span class="sidebar-user-status"><span class="status-dot guest"></span> Not logged in</span>
    </div>
    <button id="sidebarLoginBtn" class="sidebar-auth-btn">Login</button>
    <span id="sidebarUserActions" style="display:none;">
      <button id="sidebarEditProfileBtn" class="sidebar-auth-btn">Edit Profile</button>
      <button id="sidebarLogoutBtn" class="sidebar-auth-btn">Logout</button>
    </span>
  </div>
  
  <!-- Profile Stats Section -->
  <div class="sidebar-stats" style="display: none;">
    <div class="sidebar-stat-item">
      <span class="stat-label">Level</span>
      <span class="stat-value" id="sidebarLvl">?</span>
    </div>
    <div class="sidebar-stat-item">
      <span class="stat-label">Type</span>
      <span class="stat-value" id="sidebarType">?</span>
    </div>
    <div class="sidebar-stat-item">
      <span class="stat-label">Role</span>
      <span class="stat-value" id="sidebarRole">GUEST</span>
    </div>
  </div>

  <!-- Quick Actions Section -->
  <div class="sidebar-quick-actions">
    <h4 class="sidebar-section-title">Quick Actions</h4>
    <button class="quick-action-btn" data-action="newWidget">
      <span class="quick-action-icon">+</span>
      <span class="quick-action-text">Add Project to Showcase</span>
    </button>
    <button class="quick-action-btn" data-action="shareProfile">
      <span class="quick-action-icon">üì§</span>
      <span class="quick-action-text">Share Profile</span>
    </button>
    <button class="quick-action-btn" data-action="settings">
      <span class="quick-action-icon">‚öôÔ∏è</span>
      <span class="quick-action-text">Settings</span>
    </button>
            <button class="quick-action-btn" data-action="testNotifications">
          <span class="quick-action-icon">üß™</span>
          <span class="quick-action-text">Test Notifications</span>
        </button>
        <button class="quick-action-btn" data-action="testUpload">
          <span class="quick-action-icon">üì§</span>
          <span class="quick-action-text">Test Upload</span>
        </button>
  </div>

  <!-- Notifications Section -->
  <div class="sidebar-notifications">
    <h4 class="sidebar-section-title">
      Notifications
      <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
      <button id="markAllReadBtn" class="mark-all-read-btn" style="display: none;" title="Mark all as read">‚úì</button>
    </h4>
    <div class="notification-list" id="notificationList">
      <div class="notification-item empty-notification">
        <span class="notification-text">No new notifications</span>
      </div>
    </div>
  </div>

  <button class="sidebar-close-btn" aria-label="Close sidebar">&times;</button>
  <a href="assets/users/users.html" class="sidebar-nav-btn">List Users</a>
  <button class="sidebar-nav-btn" data-action="leaveNote">Leave a Note</button>
  <button class="sidebar-nav-btn" data-action="explore">Explore Creations</button>
  <button class="sidebar-nav-btn" data-action="tutorial">My Inventory</button>
</nav>
<header class="site-header">
  <button class="hamburger-menu" aria-label="Open sidebar">&#9776;</button>
  <div id="profile-banner">
    <!-- Profile Avatar Section -->
    <div class="profile-avatar-section">
      <div class="profile-pic-container">
        <div class="profile-status-indicator" id="profileStatusIndicator"></div>
      </div>
      <div class="profile-quick-actions">
        <button class="profile-action-btn" id="editProfileQuickBtn" title="Edit Profile" aria-label="Edit Profile">
          <span class="action-icon">‚úèÔ∏è</span>
        </button>
        <button class="profile-action-btn" id="tutorialBtn" title="Help & Tutorial" aria-label="Help & Tutorial">
          <span class="action-icon">‚ÑπÔ∏è</span>
        </button>
      </div>
    </div>

    <!-- Profile Info Section -->
    <div class="profile-info-section">
      <div class="profile-header">
        <h3 class="profile-name" id="profileName">Welcome</h3>
        <div class="profile-status" id="profileStatus">
          <span class="status-badge guest">Guest</span>
        </div>
      </div>
      
      <p class="profile-bio" id="profileBio">Explore the world of inque</p>
      
      <!-- Profile Stats Row -->
      <div class="profile-stats-row">
        <div class="stat-item">
          <span class="stat-label">Level</span>
          <span class="stat-value" id="profileLvl">?</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Type</span>
          <span class="stat-value" id="profileType">?</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Role</span>
          <span class="stat-value" id="profileRole">GUEST</span>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="profile-navigation">
        <button class="nav-btn primary" data-page="about" title="Learn about inque">
          <span class="nav-icon"></span>
          <span class="nav-text">About</span>
        </button>
        <button class="nav-btn secondary" data-page="explore" title="Explore creations">
          <span class="nav-icon"></span>
          <span class="nav-text">Explore</span>
        </button>
        <button class="nav-btn secondary" data-page="inventory" title="View your items">
          <span class="nav-icon"></span>
          <span class="nav-text">Inventory</span>
        </button>
        <button class="nav-btn secondary" data-page="inventory" title="View your items">
          <span class="nav-icon"></span>
          <span class="nav-text">Blog</span>
        </button>
      </div>
    </div>

    <!-- Collapse/Expand Button -->
    <button id="collapseProfileBtn" class="collapse-profile-btn" aria-label="Toggle profile details">
      <span class="collapse-icon">‚ñº</span>
    </button>
  </div>
</header>

<main>
      <section class="timeline-nav">
        <div class="timeline-3channel">
            <div class="timeline-row top">
              <!--TO DO: MOVE OPPOSITE DIRECTIONS THAN BOTTOM CHANNE timeline-row bottom-->
              <div class="timeline-event" data-id="1">
                <button class="edit-widget-btn">Edit</button>
              </div>
              <div class="timeline-event" data-id="3">
                <button class="edit-widget-btn">Edit</button>
              </div>
              <div class="timeline-event" data-id="5">
                <button class="edit-widget-btn">Edit</button>
              </div>
              <div class="timeline-event" data-id="5">
                <button class="edit-widget-btn">Edit</button>
              </div>
              <div class="timeline-event" data-id="5">
                <button class="edit-widget-btn">Edit</button>
              </div>
            </div>
            <!---Seperator-------------------------------------------------->
            <!--TO DO: ADD SLIDER FORM MOVEMENT-->
            <div class="timeline-row middle">
              <div class="timeline-track"></div>
              <div class="timeline-scrollbar">
                <div class="timeline-scrollbar-handle">
                  <span class="tooltip-text"
                    >Double-click to lock/unlock scroll</span
                  >
                </div>
              </div>
            </div>
            <!---Seperator-------------------------------------------------->
            <!--TO DO: MOVE OPPOSITE DIRECTIONS THAN TOP CHANNEL timeline-row top-->
            <div class="timeline-row bottom">
              <div class="timeline-event" data-id="2"></div>
              <div class="timeline-event" data-id="4"></div>
              <div class="timeline-event" data-id="4"></div>
              <div class="timeline-event" data-id="5"></div>
              <div class="timeline-event" data-id="5"></div>
            </div>
          </div>
        </section>
      </main>
      <footer>
        <p style="color: #aaa; font-size: 0.8rem;">&copy; 2025 inque by nicholas. All rights reserved.</p>
      </footer>

      <!-- Only ONE main script, loaded as a module -->
      <script type="module" src="script.js"></script>
      <script type="module" src="scripts/canvas.js"></script>
      <script type="module" src="scripts/auth.js"></script>
      <script type="module" src="scripts/widget-display.js"></script>

      <!-- Widget Preview Modal -->
      <div id="widgetModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Widget Preview</h2>
            <span class="close-button">&times;</span>
          </div>
          <div class="modal-body">
            <iframe id="widgetFrame" src="" frameborder="0"></iframe>
          </div>
        </div>
      </div>

      <!-- Notification Modal -->
      <div id="notificationModal" class="notification-modal">
        <div class="notification-content">
          <p id="notificationMessage">This is a notification!</p>
          <button class="notification-close-btn">&times;</button>
        </div>
      </div>

      <!-- Collaborative Canvas Modal -->
      <div id="canvasModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Collaborative Canvas</h2>
            <span class="close-button canvas-close-button">&times;</span>
          </div>
          <div class="modal-body">
            <canvas id="collabCanvas"></canvas>
            <span class="canvas-tooltip-text"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
      <div class="modal-content auth-modal-content">
        <div class="modal-header">
          <h2 id="authModalTitle" class="modal-title">Welcome to inque</h2>
          <span class="close-button auth-close-button">&times;</span>
        </div>
        <div class="modal-body">
          <!-- Login Form -->
          <form id="loginForm" class="auth-form">
            <div class="form-group">
              <label for="loginEmail">Email Address</label>
              <input type="email" id="loginEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
              <label for="loginPassword">Password</label>
              <input type="password" id="loginPassword" placeholder="Enter your password" required>
            </div>
            <div class="form-options">
              <label class="checkbox-label">
                <input type="checkbox" id="rememberMe">
                <span class="checkmark"></span>
                Remember me
              </label>
              <a href="#" class="forgot-password">Forgot password?</a>
            </div>
            <button type="submit" class="auth-submit-btn">Sign In</button>
            
            <div class="social-login">
              <div class="divider">
                <span>or continue with</span>
              </div>
              <div class="social-buttons">
                <button type="button" class="social-btn google-btn" id="googleLoginBtn">
                  <span class="social-icon">üîç</span>
                  Google
                </button>
                <button type="button" class="social-btn github-btn" id="githubLoginBtn">
                  <span class="social-icon">üêô</span>
                  GitHub
                </button>
              </div>
            </div>
            
            <p class="auth-switch">
              Don't have an account? <a href="#" id="showSignUp">Create one</a>
            </p>
          </form>

          <!-- Sign Up Form -->
          <form id="signUpForm" class="auth-form" style="display: none;">
            <div class="form-group">
              <label for="signUpEmail">Email Address</label>
              <input type="email" id="signUpEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
              <label for="signUpPassword">Password</label>
              <input type="password" id="signUpPassword" placeholder="Create a password" required>
              <div class="password-strength" id="passwordStrength"></div>
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm Password</label>
              <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
            </div>
            <div class="form-options">
              <label class="checkbox-label">
                <input type="checkbox" id="agreeTerms" required>
                <span class="checkmark"></span>
                I agree to the <a href="#" class="terms-link">Terms of Service</a> and <a href="#" class="terms-link">Privacy Policy</a>
              </label>
            </div>
            <button type="submit" class="auth-submit-btn">Create Account</button>
            
            <div class="social-login">
              <div class="divider">
                <span>or sign up with</span>
              </div>
              <div class="social-buttons">
                <button type="button" class="social-btn google-btn" id="googleSignUpBtn">
                  <span class="social-icon">üîç</span>
                  Google
                </button>
                <button type="button" class="social-btn github-btn" id="githubSignUpBtn">
                  <span class="social-icon">üêô</span>
                  GitHub
                </button>
              </div>
            </div>
            
            <p class="auth-switch">
              Already have an account? <a href="#" id="showLogin">Sign in</a>
            </p>
          </form>
        </div>
      </div>
    </div>

  </body>
</html>

<!-- Toast Notification System -->
<div id="toast-container" class="toast-container">
  <!-- Toast notifications will be dynamically added here -->
</div>

<div id="error-toast" class="error-toast">
  <span id="error-toast-message"></span>
  <button id="error-toast-close">&times;</button>
</div>

<!-- Floating button to expand header if collapsed -->
<script>
  // Sidebar open/close logic
  const sidebar = document.querySelector('.sidebar-nav');
  const overlay = document.querySelector('.sidebar-overlay');
  const openBtn = document.querySelector('.hamburger-menu');
  const closeBtn = document.querySelector('.sidebar-close-btn');
  function openSidebar() {
    sidebar.classList.add('open');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
  function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  }
  openBtn.addEventListener('click', openSidebar);
  closeBtn.addEventListener('click', closeSidebar);
  overlay.addEventListener('click', closeSidebar);
  // Swipe gesture for mobile
  let startX = null;
  document.addEventListener('touchstart', function(e) {
    if (e.touches[0].clientX < 30 && !sidebar.classList.contains('open')) {
      startX = e.touches[0].clientX;
    } else if (sidebar.classList.contains('open')) {
      startX = e.touches[0].clientX;
    } else {
      startX = null;
    }
  });
  document.addEventListener('touchmove', function(e) {
    if (startX !== null) {
      let dx = e.touches[0].clientX - startX;
      if (!sidebar.classList.contains('open') && dx > 60) {
        openSidebar();
        startX = null;
      } else if (sidebar.classList.contains('open') && dx < -60) {
        closeSidebar();
        startX = null;
      }
    }
  });
  document.addEventListener('touchend', function() { startX = null; });
</script>

<script>
  // Profile navigation buttons
  const profileNavBtns = document.querySelectorAll('.nav-btn');
  profileNavBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const page = btn.getAttribute('data-page');
      console.log(`Navigating to: ${page}`);
      
      switch(page) {
        case 'about':
          // Navigate to about page
          window.location.href = '/about.html';
          break;
        case 'explore':
          // Navigate to explore page
          window.location.href = '/explore.html';
          break;
        case 'inventory':
          // Navigate to inventory page
          window.location.href = '/inventory.html';
          break;
        default:
          console.log('Unknown page:', page);
      }
    });
  });
</script>

<script>
  // Tutorial button functionality
  const tutorialBtn = document.getElementById('tutorialBtn');
  tutorialBtn.addEventListener('click', () => {
    console.log('Tutorial button clicked');
    // For now, just show an alert. In the future, this will open a comprehensive tutorial
    alert('Tutorial feature coming soon! This will explain everything about inque.');
  });

  // Social media banners functionality
  const socialBanners = document.querySelectorAll('.social-banner');
  socialBanners.forEach(banner => {
    banner.addEventListener('click', () => {
      const platform = banner.getAttribute('data-platform');
      console.log(`Social banner clicked: ${platform}`);
      
      // Define social media URLs (replace with actual URLs)
      const socialUrls = {
        twitter: 'https://twitter.com/inque',
        instagram: 'https://instagram.com/inque',
        discord: 'https://discord.gg/inque',
        youtube: 'https://youtube.com/@inque'
      };
      
      const url = socialUrls[platform];
      if (url) {
        window.open(url, '_blank');
      } else {
        console.log(`No URL defined for ${platform}`);
      }
    });
  });
</script>

<script>
// Profile banner collapse/expand logic
(function() {
  const collapseBtn = document.getElementById('collapseProfileBtn');
  const profileBanner = document.getElementById('profile-banner');
  const collapseIcon = collapseBtn.querySelector('.collapse-icon');
  let collapsed = false;

  if (collapseBtn && profileBanner && collapseIcon) {
    collapseBtn.addEventListener('click', () => {
      collapsed = !collapsed;
      if (collapsed) {
        profileBanner.classList.add('collapsed');
        profileBanner.style.maxHeight = '120px';
        profileBanner.style.overflow = 'hidden';
        collapseBtn.classList.add('collapsed');
        collapseIcon.textContent = '‚ñ≤';
      } else {
        profileBanner.classList.remove('collapsed');
        profileBanner.style.maxHeight = 'none';
        profileBanner.style.overflow = 'visible';
        collapseBtn.classList.remove('collapsed');
        collapseIcon.textContent = '‚ñº';
      }
    });
  }
})();
</script>

<!-- Add Edit Widget Modal -->
<div id="editWidgetModal" class="modal">
  <div class="modal-content edit-widget-modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Edit Widget Properties</h2>
      <span class="close-button edit-widget-close">&times;</span>
    </div>
    <div class="modal-body">
      <form id="editWidgetForm" class="edit-widget-form">
        <div class="form-group">
          <label for="widgetTitle">Widget Title</label>
          <input type="text" id="widgetTitle" name="widgetTitle" placeholder="Enter widget title" required />
        </div>
        <div class="form-group">
          <label for="widgetDescription">Description</label>
          <textarea id="widgetDescription" name="widgetDescription" placeholder="Enter description" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="widgetColor">Color</label>
          <input type="color" id="widgetColor" name="widgetColor" />
        </div>
        <div class="edit-actions">
          <button type="submit" class="primary-btn">Save</button>
          <button type="button" class="secondary-btn edit-widget-close">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Edit Widget Modal logic
const editWidgetModal = document.getElementById('editWidgetModal');
const editWidgetForm = document.getElementById('editWidgetForm');
const editWidgetCloseBtns = document.querySelectorAll('.edit-widget-close');
const editWidgetBtns = document.querySelectorAll('.edit-widget-btn');

editWidgetBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    editWidgetModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  });
});
editWidgetCloseBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    editWidgetModal.style.display = 'none';
    document.body.style.overflow = '';
  });
});
window.addEventListener('click', (e) => {
  if (e.target === editWidgetModal) {
    editWidgetModal.style.display = 'none';
    document.body.style.overflow = '';
  }
});
editWidgetForm.addEventListener('submit', (e) => {
  e.preventDefault();
  // For demo: just close modal
  editWidgetModal.style.display = 'none';
  document.body.style.overflow = '';
  // You can add your save logic here!
});
</script>

<!-- Enhanced Profile & Settings Modal -->
<div id="editProfileModal" class="modal">
  <div class="modal-content edit-profile-modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Profile & Settings</h2>
      <span class="close-button edit-profile-close-button">&times;</span>
    </div>
    <div class="modal-body">
      
      <!-- Unified Settings Layout -->
      <div class="settings-container">
        
        <!-- Profile Section -->
        <div class="settings-section">
          <div class="section-header">
            <h3>üë§ Profile Information</h3>
            <p class="section-description">Customize your public profile and personal details</p>
          </div>
          
          <div class="profile-settings-grid">
            <!-- Profile Photo -->
            <div class="profile-photo-section">
              <div class="current-photo">
                <div class="photo-preview" id="profilePhotoPreview"></div>
                <div class="photo-overlay">
                  <span class="photo-icon">üì∑</span>
                  <span class="photo-text">Change Photo</span>
                </div>
              </div>
              <input type="file" id="editPhoto" name="editPhoto" accept="image/*" class="photo-input" />
            </div>
            
            <!-- Profile Details -->
            <div class="profile-details">
              <div class="form-group">
                <label for="editProfileName">Display Name</label>
                <input type="text" id="editProfileName" name="editProfileName" placeholder="Enter your display name" required />
              </div>
              <div class="form-group">
                <label for="editProfileBio">Bio</label>
                <textarea id="editProfileBio" name="editProfileBio" placeholder="Tell us about yourself..." rows="3"></textarea>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Account Settings -->
        <div class="settings-section">
          <div class="section-header">
            <h3>‚öôÔ∏è Account Settings</h3>
            <p class="section-description">Manage your account preferences and security</p>
          </div>
          
          <div class="account-settings-grid">
            <div class="setting-item">
              <div class="setting-info">
                <h4>Email Notifications</h4>
                <p>Receive updates about your widgets and activity</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="emailNotifications" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <div class="setting-item">
              <div class="setting-info">
                <h4>Public Profile</h4>
                <p>Allow others to view your profile and widgets</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="publicProfile" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <div class="setting-item">
              <div class="setting-info">
                <h4>Auto-save</h4>
                <p>Automatically save changes to your widgets</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="autoSave" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Widget Management -->
        <div class="settings-section">
          <div class="section-header">
            <h3>üé® Widget Showcase</h3>
            <p class="section-description">Upload and manage your interactive widgets</p>
          </div>
          
          <div class="widget-showcase-grid">
            <div class="widget-slot" data-slot="1">
              <div class="slot-header">
                <h4>Slot 1</h4>
                <span class="slot-status">Available</span>
              </div>
              <div class="widget-slot-content">
                <div class="widget-upload-area">
                  <input type="file" class="widget-file-input" data-slot="1" multiple accept=".html,.js,.css,.png,.jpg,.jpeg,.gif,.svg,.json">
                  <div class="upload-placeholder">
                    <span class="upload-icon">üìÅ</span>
                    <p>Drop files here or click to upload</p>
                  </div>
                </div>
                <div class="widget-slot-info">
                  <input type="text" class="widget-title-input" data-slot="1" placeholder="Widget Title">
                  <textarea class="widget-desc-input" data-slot="1" placeholder="Widget Description" rows="2"></textarea>
                </div>
                <button class="upload-widget-btn" data-slot="1">Upload to Slot 1</button>
              </div>
            </div>
            
            <div class="widget-slot" data-slot="2">
              <div class="slot-header">
                <h4>Slot 2</h4>
                <span class="slot-status">Available</span>
              </div>
              <div class="widget-slot-content">
                <div class="widget-upload-area">
                  <input type="file" class="widget-file-input" data-slot="2" multiple accept=".html,.js,.css,.png,.jpg,.jpeg,.gif,.svg,.json">
                  <div class="upload-placeholder">
                    <span class="upload-icon">üìÅ</span>
                    <p>Drop files here or click to upload</p>
                  </div>
                </div>
                <div class="widget-slot-info">
                  <input type="text" class="widget-title-input" data-slot="2" placeholder="Widget Title">
                  <textarea class="widget-desc-input" data-slot="2" placeholder="Widget Description" rows="2"></textarea>
                </div>
                <button class="upload-widget-btn" data-slot="2">Upload to Slot 2</button>
              </div>
            </div>
            
            <div class="widget-slot" data-slot="3">
              <div class="slot-header">
                <h4>Slot 3</h4>
                <span class="slot-status">Available</span>
              </div>
              <div class="widget-slot-content">
                <div class="widget-upload-area">
                  <input type="file" class="widget-file-input" data-slot="3" multiple accept=".html,.js,.css,.png,.jpg,.jpeg,.gif,.svg,.json">
                  <div class="upload-placeholder">
                    <span class="upload-icon">üìÅ</span>
                    <p>Drop files here or click to upload</p>
                  </div>
                </div>
                <div class="widget-slot-info">
                  <input type="text" class="widget-title-input" data-slot="3" placeholder="Widget Title">
                  <textarea class="widget-desc-input" data-slot="3" placeholder="Widget Description" rows="2"></textarea>
                </div>
                <button class="upload-widget-btn" data-slot="3">Upload to Slot 3</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="settings-actions">
          <button type="submit" class="primary-btn" id="saveAllSettings">
            <span class="btn-icon">üíæ</span>
            Save All Changes
          </button>
          <button type="button" class="secondary-btn edit-profile-close-button">
            <span class="btn-icon">‚úï</span>
            Cancel
          </button>
        </div>
        
      </div>
      
    </div>
  </div>
</div>
<script type="module">
import { db, auth, storage } from './scripts/firebase-init.js';
import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";
import { uploadWidgetToSlot } from './scripts/upload.js';
import { saveWidgetSlotMetadata } from './scripts/project-manager.js';

const editProfileModal = document.getElementById('editProfileModal');
const editProfileForm = document.getElementById('editProfileForm');
const editProfileCloseBtns = document.querySelectorAll('.edit-profile-close-button');
const editProfileQuickBtn = document.getElementById('editProfileQuickBtn');
const editProfileName = document.getElementById('editProfileName');
const editProfileBio = document.getElementById('editProfileBio');
const editPhotoInput = document.getElementById('editPhoto');
let currentPhotoURL = null;

// Enhanced profile photo handling
const profilePhotoPreview = document.getElementById('profilePhotoPreview');
const currentPhoto = document.querySelector('.current-photo');

// Set up photo click handler
if (currentPhoto) {
  currentPhoto.addEventListener('click', () => {
    editPhotoInput.click();
  });
}

// Live image preview
const photoPreview = document.createElement('img');
photoPreview.style.display = 'none';
photoPreview.style.width = '80px';
photoPreview.style.height = '80px';
photoPreview.style.borderRadius = '50%';
photoPreview.style.marginTop = '10px';
editPhotoInput.parentNode.appendChild(photoPreview);

// Pre-fill form with current user info
async function prefillProfileForm() {
  const user = auth.currentUser;
  if (!user) return;
  const userDoc = await getDoc(doc(db, 'users', user.uid));
  if (userDoc.exists()) {
    const data = userDoc.data();
    editProfileName.value = data.name || '';
    editProfileBio.value = data.bio || '';
    currentPhotoURL = data.photoURL || '';
    
    // Update profile photo preview
    if (profilePhotoPreview) {
      if (currentPhotoURL) {
        profilePhotoPreview.style.backgroundImage = `url(${currentPhotoURL})`;
      } else {
        profilePhotoPreview.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      }
    }
    
    if (currentPhotoURL) {
      photoPreview.src = currentPhotoURL;
      photoPreview.style.display = 'block';
    } else {
      photoPreview.style.display = 'none';
    }
  }
}

// Widget upload functionality
const uploadWidgetBtns = document.querySelectorAll('.upload-widget-btn');
const widgetFileInputs = document.querySelectorAll('.widget-file-input');

uploadWidgetBtns.forEach(btn => {
  btn.addEventListener('click', async () => {
    const slot = btn.getAttribute('data-slot');
    const fileInput = document.querySelector(`.widget-file-input[data-slot="${slot}"]`);
    const titleInput = document.querySelector(`.widget-title-input[data-slot="${slot}"]`);
    const descInput = document.querySelector(`.widget-desc-input[data-slot="${slot}"]`);
    
    if (!fileInput.files.length) {
      alert('Please select files to upload.');
      return;
    }
    
    // Validate files
    if (window.validateWidgetFiles && !window.validateWidgetFiles(fileInput.files)) {
      alert('Invalid file type selected. Allowed: html, js, css, png, jpg, jpeg, gif, svg, json.');
      return;
    }
    
    const title = titleInput.value.trim() || 'Untitled Widget';
    const desc = descInput.value.trim() || '';
    
    btn.textContent = 'Uploading...';
    btn.disabled = true;
    
    try {
      console.log(`Starting upload for slot ${slot}...`);
      
      // Use the imported uploadWidgetToSlot function
      const fileURLs = await uploadWidgetToSlot(fileInput.files, slot);
      console.log('Files uploaded successfully:', fileURLs);
      
      // Save metadata using the imported function
      await saveWidgetSlotMetadata(`app-widget-${slot}`, {
        title,
        desc,
        files: fileURLs,
        updated: new Date(),
      });
      console.log('Metadata saved successfully');
      
      btn.textContent = `Uploaded to Slot ${slot}!`;
      btn.style.background = 'linear-gradient(45deg, #4caf50, #45a049)';
      
      // Reset form after successful upload
      setTimeout(() => {
        btn.textContent = `Upload to Slot ${slot}`;
        btn.disabled = false;
        btn.style.background = 'linear-gradient(45deg, #4caf50, #45a049)';
        fileInput.value = '';
        titleInput.value = '';
        descInput.value = '';
      }, 2000);
      
    } catch (error) {
      console.error('Upload error:', error);
      btn.textContent = 'Upload Failed';
      btn.style.background = 'linear-gradient(45deg, #f44336, #d32f2f)';
      alert('Upload failed: ' + error.message);
      
      setTimeout(() => {
        btn.textContent = `Upload to Slot ${slot}`;
        btn.disabled = false;
        btn.style.background = 'linear-gradient(45deg, #4caf50, #45a049)';
      }, 2000);
    }
  });
});

// Drag and drop functionality for widget uploads
widgetFileInputs.forEach(input => {
  const uploadArea = input.closest('.widget-upload-area');
  
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--primary-color)';
    uploadArea.style.background = 'rgba(0, 240, 255, 0.1)';
  });
  
  uploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = '#555';
    uploadArea.style.background = '#0f0f0f';
  });
  
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = '#555';
    uploadArea.style.background = '#0f0f0f';
    
    const files = e.dataTransfer.files;
    input.files = files;
    
    // Show selected files
    const placeholder = uploadArea.querySelector('.upload-placeholder p');
    if (files.length > 0) {
      placeholder.textContent = `${files.length} file(s) selected`;
    }
  });
});

if (editProfileQuickBtn) {
  editProfileQuickBtn.addEventListener('click', () => {
    prefillProfileForm();
    editProfileModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  });
}

editProfileCloseBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    editProfileModal.style.display = 'none';
    document.body.style.overflow = '';
  });
});

window.addEventListener('click', (e) => {
  if (e.target === editProfileModal) {
    editProfileModal.style.display = 'none';
    document.body.style.overflow = '';
  }
});

// Live image preview on file select
editPhotoInput.addEventListener('change', function() {
  if (this.files && this.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      // Update both previews
      photoPreview.src = e.target.result;
      photoPreview.style.display = 'block';
      
      if (profilePhotoPreview) {
        profilePhotoPreview.style.backgroundImage = `url(${e.target.result})`;
      }
    };
    reader.readAsDataURL(this.files[0]);
  } else if (currentPhotoURL) {
    photoPreview.src = currentPhotoURL;
    photoPreview.style.display = 'block';
    
    if (profilePhotoPreview) {
      profilePhotoPreview.style.backgroundImage = `url(${currentPhotoURL})`;
    }
  } else {
    photoPreview.style.display = 'none';
    
    if (profilePhotoPreview) {
      profilePhotoPreview.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }
  }
});

// Save all settings functionality
const saveAllSettingsBtn = document.getElementById('saveAllSettings');

if (saveAllSettingsBtn) {
  saveAllSettingsBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return;
    
    // Show loading state
    saveAllSettingsBtn.textContent = 'Saving...';
    saveAllSettingsBtn.disabled = true;
    
    try {
      const name = editProfileName.value.trim();
      const bio = editProfileBio.value.trim();
      let photoURL = currentPhotoURL;
      
      // If a new photo is selected, upload it
      if (editPhotoInput.files && editPhotoInput.files[0]) {
        try {
          const file = editPhotoInput.files[0];
          const storageRef = ref(storage, `users/${user.uid}/profile-photo.jpg`);
          await uploadBytes(storageRef, file);
          photoURL = await getDownloadURL(storageRef);
          console.log('Profile photo uploaded successfully');
        } catch (storageError) {
          console.warn('Failed to upload profile photo:', storageError);
        }
      }
      
      // Get settings values
      const emailNotifications = document.getElementById('emailNotifications')?.checked || false;
      const publicProfile = document.getElementById('publicProfile')?.checked || false;
      const autoSave = document.getElementById('autoSave')?.checked || false;
      
      // Update Firestore with all settings
      await updateDoc(doc(db, 'users', user.uid), {
        name,
        bio,
        photoURL,
        settings: {
          emailNotifications,
          publicProfile,
          autoSave,
          updatedAt: new Date()
        }
      });
      
      // Show success message
      showToast('All settings saved successfully! üéâ', 'success');
      
      // Close modal after a short delay
      setTimeout(() => {
        editProfileModal.style.display = 'none';
        document.body.style.overflow = '';
        location.reload();
      }, 1500);
      
    } catch (error) {
      console.error('Failed to save settings:', error);
      showToast('Failed to save settings. Please try again.', 'error');
    } finally {
      // Reset button state
      saveAllSettingsBtn.textContent = 'Save All Changes';
      saveAllSettingsBtn.disabled = false;
    }
  });
}

// Legacy form handler (for backward compatibility)
if (editProfileForm) {
  editProfileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) return;
    const name = editProfileName.value.trim();
    const bio = editProfileBio.value.trim();
    let photoURL = currentPhotoURL;
    
    // If a new photo is selected, upload it
    if (editPhotoInput.files && editPhotoInput.files[0]) {
      try {
        const file = editPhotoInput.files[0];
        const storageRef = ref(storage, `users/${user.uid}/profile-photo.jpg`);
        await uploadBytes(storageRef, file);
        photoURL = await getDownloadURL(storageRef);
        console.log('Profile photo uploaded successfully');
      } catch (storageError) {
        console.warn('Failed to upload profile photo:', storageError);
        // Continue without photo upload - don't fail the entire profile update
      }
    }
    
    try {
      // Update Firestore
      await updateDoc(doc(db, 'users', user.uid), {
        name,
        bio,
        photoURL
      });
      editProfileModal.style.display = 'none';
      document.body.style.overflow = '';
      alert('Profile updated!');
      location.reload();
    } catch (error) {
      console.error('Failed to update profile:', error);
      alert('Failed to update profile. Please try again.');
    }
  });
}
</script>
